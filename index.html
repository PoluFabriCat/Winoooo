<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover,maximum-scale=1,user-scalable=no" />
  <meta name="theme-color" content="#0b0c0f" />
  <title>–í–∞–ª–µ–Ω—Ç–∏–Ω–∫–∞</title>
  <style>
    :root{
      --bg:#0b0c0f;

      --paper:#f2efe5;
      --paper2:#eae4d5;

      --cardboard:#c7a07a;
      --cardboard2:#ad8460;

      --pink:#ff4d7d;
      --pink2:#ffb3c7;

      --radius:22px;
      --radius2:28px;

      --safeTop: env(safe-area-inset-top, 0px);
      --safeBottom: env(safe-area-inset-bottom, 0px);
      --safeLeft: env(safe-area-inset-left, 0px);
      --safeRight: env(safe-area-inset-right, 0px);

      --shadow: 0 18px 40px rgba(0,0,0,.42);
      --shadow2: 0 10px 22px rgba(0,0,0,.28);
    }

    *{box-sizing:border-box; -webkit-tap-highlight-color:transparent;}
    html,body{height:100%; margin:0; background: var(--bg); overflow:hidden;}
    body{
      font-family: ui-rounded, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color:#f6f6f8;
      user-select:none;
      touch-action: pan-x pan-y;
      overscroll-behavior: none;
    }

    /* ===== CRT + Pixel TV feel ===== */
    .crt{
      position:fixed; inset:0; pointer-events:none; z-index:60;
      opacity:.18;
      mix-blend-mode:multiply;
      background:
        repeating-linear-gradient(
          to bottom,
          rgba(255,255,255,.035) 0px,
          rgba(255,255,255,.035) 1px,
          rgba(0,0,0,0) 3px,
          rgba(0,0,0,0) 6px
        );
      animation: flick 6.5s linear infinite;
    }
    @keyframes flick{
      0%,100%{opacity:.16}
      30%{opacity:.21}
      55%{opacity:.14}
      80%{opacity:.22}
    }

    .crtMask{
      position:fixed; inset:0; pointer-events:none; z-index:61;
      opacity:.12;
      mix-blend-mode: overlay;
      background:
        repeating-linear-gradient(
          90deg,
          rgba(255,0,0,.07) 0px,
          rgba(255,0,0,.07) 1px,
          rgba(0,255,255,.05) 1px,
          rgba(0,255,255,.05) 2px
        );
      animation: jitter 3.6s steps(10) infinite;
    }
    @keyframes jitter{
      0%,100%{transform: translate(0,0)}
      20%{transform: translate(.4px,0)}
      40%{transform: translate(-.6px,0)}
      60%{transform: translate(.2px,-.2px)}
      80%{transform: translate(-.3px,.2px)}
    }

    /* extra pixel grid overlay */
    .pxGrid{
      position:fixed; inset:0; pointer-events:none; z-index:62;
      opacity:.14;
      mix-blend-mode: overlay;
      background:
        linear-gradient(rgba(255,255,255,.10) 1px, rgba(0,0,0,0) 1px) 0 0/8px 8px,
        linear-gradient(90deg, rgba(255,255,255,.10) 1px, rgba(0,0,0,0) 1px) 0 0/8px 8px;
      filter: contrast(1.2);
      animation: pxShift 1.8s steps(6) infinite;
    }
    @keyframes pxShift{
      0%{transform: translate(0,0)}
      50%{transform: translate(1px,0)}
      100%{transform: translate(0,0)}
    }

    .paper{
      position:relative;
      background: linear-gradient(180deg, var(--paper) 0%, var(--paper2) 100%);
      color: rgba(20,20,24,.92);
      border: 1px solid rgba(0,0,0,.14);
      border-radius: var(--radius2);
      box-shadow: var(--shadow2);
      overflow:hidden;
    }
    .paper::before{
      content:"";
      position:absolute; inset:0; pointer-events:none;
      background:
        url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='180' height='180'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='.85' numOctaves='2' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='180' height='180' filter='url(%23n)' opacity='.22'/%3E%3C/svg%3E") repeat;
      mix-blend-mode:multiply;
      opacity:.45;
      transform: scale(1.05);
    }
    .paper::after{
      content:"";
      position:absolute; inset:0; pointer-events:none;
      background:
        radial-gradient(900px 520px at 50% 0%, rgba(0,0,0,.06), rgba(0,0,0,0) 60%),
        radial-gradient(700px 420px at 0% 100%, rgba(0,0,0,.05), rgba(0,0,0,0) 62%),
        radial-gradient(700px 420px at 100% 100%, rgba(0,0,0,.05), rgba(0,0,0,0) 62%);
      opacity:.9;
    }

    #app{
      position:fixed; inset:0;
      padding: calc(14px + var(--safeTop)) calc(14px + var(--safeRight)) calc(14px + var(--safeBottom)) calc(14px + var(--safeLeft));
      display:flex; align-items:center; justify-content:center;
    }
    .stage{
      width:min(430px, 100%);
      height:min(820px, 100%);
      display:flex;
      flex-direction:column;
      gap:12px;
      position:relative;
    }

    .viewport{
      position:relative;
      flex:1;
      border-radius: var(--radius2);
      overflow:hidden;
      box-shadow: var(--shadow);
      border: 1px solid rgba(255,255,255,.04);
      background:
        radial-gradient(900px 600px at 100% 0%, rgba(255,90,150,.38), rgba(255,90,150,0) 100%),
        linear-gradient(180deg, #14151a 0%, #0c0d11 100%);
      transform: translateZ(0);
    }

    .scene{
      position:absolute; inset:0;
      padding: 14px;
      display:flex;
      flex-direction:column;
      justify-content:center;
      gap:14px;
      opacity:0;
      transform: translateY(10px);
      pointer-events:none;
      transition: opacity .45s ease, transform .55s cubic-bezier(.2,.8,.2,1);
    }
    .scene.active{
      opacity:1; transform: translateY(0);
      pointer-events:auto;
    }

    .center{flex:1; display:flex; align-items:center; justify-content:center; position:relative;}

    .bubble{
      align-self:center;
      max-width: 92%;
      padding: 12px 14px;
      border-radius: 22px;
      background: linear-gradient(180deg, #f3f0e7, #ebe3d5);
      border: 1px solid rgba(0,0,0,.12);
      box-shadow: var(--shadow2);
      color: rgba(20,20,24,.88);
    }
    .bubble .who{font-size:12px; opacity:.7; font-weight:900; margin-bottom:6px;}
    .bubble .txt{font-size:16px; font-weight:900; letter-spacing:.1px;}
    .bubble.small .txt{font-size:14px;}
    .shake{animation: shake .35s ease;}
    @keyframes shake{
      0%{transform:translateX(0)}
      25%{transform:translateX(-6px)}
      55%{transform:translateX(6px)}
      75%{transform:translateX(-4px)}
      100%{transform:translateX(0)}
    }

    .row{display:flex; gap:10px; justify-content:center; flex-wrap:wrap;}

    .btn{
      border:none;
      padding: 12px 16px;
      border-radius: 20px;
      font-weight: 950;
      font-size: 14px;
      letter-spacing:.2px;
      cursor:pointer;
      user-select:none;
      touch-action: manipulation;
      color: rgba(20,20,24,.88);
      background: linear-gradient(180deg, #f3f0e7, #e9e1d3);
      border: 1px solid rgba(0,0,0,.12);
      box-shadow: 0 10px 18px rgba(0,0,0,.18);
      transition: transform .12s ease, filter .12s ease, opacity .22s ease;
    }
    .btn:active{transform: translateY(1px) scale(.99); filter: brightness(.98);}
    .btn.primary{
      background: linear-gradient(180deg, rgba(255,179,199,.95), rgba(255,179,199,.70));
      border: 1px solid rgba(0,0,0,.12);
    }
    .btn.danger{
      background: linear-gradient(180deg, rgba(255,185,185,.92), rgba(255,185,185,.70));
      border: 1px solid rgba(0,0,0,.12);
    }
    .btn.ghost{
      background: linear-gradient(180deg, rgba(245,240,230,.70), rgba(235,227,210,.70));
      border: 1px dashed rgba(0,0,0,.20);
    }
    .btn.wide{min-width: 160px;}
    .btn.hidden{opacity:0; pointer-events:none; transform: translateX(12px) scale(.98);}

    .modalWrap{
      position:absolute; inset:0;
      display:flex; align-items:center; justify-content:center;
      padding: 16px;
      background: rgba(0,0,0,.35);
      opacity:0; pointer-events:none;
      transition: opacity .28s ease;
      z-index: 10;
    }
    .modalWrap.show{opacity:1; pointer-events:auto;}
    .modal{
      width:min(390px, 100%);
      padding: 16px;
      border-radius: var(--radius2);
      transform: translateY(10px) scale(.99);
      transition: transform .35s cubic-bezier(.2,.8,.2,1);
    }
    .modalWrap.show .modal{transform: translateY(0) scale(1);}
    .modal h3{margin:0 0 8px 0; font-size:16px; font-weight:950;}
    .modal p{margin:0 0 14px 0; font-size:13px; font-weight:800; color: rgba(20,20,24,.70);}

    /* 3D stage */
    .objectStage{
      width:100%;
      height:100%;
      display:flex; align-items:center; justify-content:center;
      position:relative;
    }
    .objWrap{
      width: min(330px, 86vw);
      aspect-ratio: 1 / 1;
      position:relative;
      perspective: 950px;
      filter: drop-shadow(0 28px 28px rgba(0,0,0,.45));
      touch-action: none;
    }
    .obj{
      width:100%; height:100%;
      position:absolute; inset:0;
      transform-style: preserve-3d;
      will-change: transform;
    }

    .pixelFrame{
      position:absolute; inset:0; border-radius: 28px; pointer-events:none;
      box-shadow: inset 0 0 0 2px rgba(0,0,0,.10);
    }
    .pixelFrame::after{
      content:"";
      position:absolute; inset: 6px;
      border-radius: 22px;
      border: 1px solid rgba(255,255,255,.06);
      opacity:.9;
    }

    /* ===== Box cuboid ===== */
    .box3d{
      --w: 270px;
      --h: 240px;
      --d: 170px;
      position:absolute;
      left:50%; top:50%;
      transform: translate(-50%,-50%);
      transform-style: preserve-3d;
    }
    .bface{
      position:absolute;
      left:50%; top:50%;
      border-radius: 22px;
      border: 1px solid rgba(0,0,0,.18);
      overflow:hidden;
      background: linear-gradient(180deg, var(--cardboard), var(--cardboard2));
    }
    .bface::before{
      content:"";
      position:absolute; inset:0;
      background:
        url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='220' height='220'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='.75' numOctaves='2' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='220' height='220' filter='url(%23n)' opacity='.16'/%3E%3C/svg%3E") repeat;
      mix-blend-mode:multiply; opacity:.55;
      transform: scale(1.06);
      pointer-events:none;
    }
    .bface::after{
      content:"";
      position:absolute; inset:0;
      background:
        radial-gradient(220px 160px at 25% 15%, rgba(255,255,255,.18), rgba(255,255,255,0) 62%),
        radial-gradient(240px 180px at 80% 20%, rgba(255,255,255,.12), rgba(255,255,255,0) 65%),
        linear-gradient(180deg, rgba(0,0,0,.05), rgba(0,0,0,0) 40%);
      opacity:.95;
      pointer-events:none;
    }

    .bface.front, .bface.back{ width: var(--w); height: var(--h); }
    .bface.right, .bface.left{
      width: var(--d); height: var(--h);
      background: linear-gradient(180deg, #b08863, #8f6a49);
    }
    .bface.top, .bface.bottom{ width: var(--w); height: var(--d); }
    .bface.back{ background: linear-gradient(180deg, #b18a64, #916a49); }
    .bface.bottom{ background: linear-gradient(180deg, #9a7350, #7a5a3f); }
    .bface.top{ background: linear-gradient(180deg, #d3b08d, #b99570); }

    .bface.front  { transform: translate(-50%,-50%) rotateY(0deg)   translateZ(calc(var(--d)/2)); }
    .bface.back   { transform: translate(-50%,-50%) rotateY(180deg) translateZ(calc(var(--d)/2)); }
    .bface.right  { transform: translate(-50%,-50%) rotateY(90deg)  translateZ(calc(var(--w)/2)); }
    .bface.left   { transform: translate(-50%,-50%) rotateY(-90deg) translateZ(calc(var(--w)/2)); }

    /* FIX: top/bottom slightly inset to avoid "floating lid" look */
    .bface.top{
      transform: translate(-50%,-50%)
                 translateY(calc(var(--h)/-2))
                 rotateX(90deg);
    }


    /* lid open animation */
    .box3d.opened .bface.top{
      transform: translate(-50%,-50%) rotateX(90deg) translateZ(calc(var(--h)/2 - 1px)) rotateX(-105deg);
    }
    .bface.bottom{
          transform: translate(-50%,-50%)
                     translateY(calc(var(--h)/2))
                     rotateX(-90deg);
        }

    .label{
      position:absolute; left: 12%; right:12%; top: 12%;
      padding: 10px 12px;
      border-radius: 16px;
      background: linear-gradient(180deg, rgba(255,255,255,.74), rgba(240,235,220,.90));
      border: 1px solid rgba(0,0,0,.12);
      box-shadow: 0 10px 18px rgba(0,0,0,.16);
      text-align:center;
      font-weight: 950;
      color: rgba(20,20,24,.88);
    }
    .label small{
      display:block;
      margin-top:4px;
      font-size:12px;
      font-weight:900;
      color: rgba(30,30,34,.58);
    }
    .tape{
      position:absolute; left: 10%; right:10%; top: 46%;
      height: 16%;
      border-radius: 18px;
      background: linear-gradient(180deg, rgba(255,240,200,.82), rgba(230,205,160,.80));
      border:1px solid rgba(0,0,0,.12);
      transform: rotate(-3deg);
      box-shadow: inset 0 2px 0 rgba(255,255,255,.20), inset 0 -2px 0 rgba(0,0,0,.10);
      opacity:.95;
    }

    /* 3D lock on box */
    .lock3d{
      position:absolute;
      left:50%; top: 66%;
      width: 92px; height: 92px;
      transform: translate(-50%,-50%);
      transform-style: preserve-3d;
      cursor:pointer;
      touch-action: manipulation;
      z-index: 5;
    }
    .lockBody{
      position:absolute; inset:0;
      border-radius: 22px;
      background: linear-gradient(180deg, #f2ddaa, #d9b96a);
      border: 1px solid rgba(0,0,0,.16);
      box-shadow: 0 14px 22px rgba(0,0,0,.22);
      transform: translateZ(10px);
    }
    .lockBody::before{
      content:"";
      position:absolute; inset:10px;
      border-radius: 18px;
      background: rgba(0,0,0,.08);
      border: 1px dashed rgba(0,0,0,.18);
    }
    .lockBack{
      position:absolute; inset:0;
      border-radius: 22px;
      background: linear-gradient(180deg, #caa95f, #b08a3c);
      border: 1px solid rgba(0,0,0,.16);
      transform: translateZ(-10px);
    }
    .lockSide{
      position:absolute;
      left:0; top:0;
      width: 20px; height: 92px;
      background: linear-gradient(180deg, #caa95f, #9e7a2f);
      border: 1px solid rgba(0,0,0,.16);
      transform-origin: left center;
      transform: rotateY(90deg) translateZ(10px);
      border-radius: 10px;
    }
    .lockSide.r{
      left:auto; right:0;
      transform-origin: right center;
      transform: rotateY(-90deg) translateZ(10px);
    }
    .lockShackle{
      position:absolute;
      left:50%; top: 18%;
      width: 36px; height: 26px;
      transform: translate(-50%,-50%) translateZ(12px);
      border-radius: 16px 16px 12px 12px;
      border: 6px solid rgba(30,24,10,.55);
      border-bottom: 0;
      opacity:.95;
    }
    .lockKeyhole{
      position:absolute;
      left:50%; top: 62%;
      width: 20px; height: 28px;
      transform: translate(-50%,-50%) translateZ(12px);
      border-radius: 10px;
      background: rgba(30,24,10,.55);
      box-shadow: inset 0 2px 0 rgba(255,255,255,.16);
    }
    .lock3d.pulse{ animation: lockPulse 1.25s infinite ease-in-out; }
    @keyframes lockPulse{
      0%,100%{transform: translate(-50%,-50%) scale(1)}
      50%{transform: translate(-50%,-50%) scale(1.06)}
    }

    /* ===== Fixed envelope 3D prism ===== */
    .env3d{
      --w: 280px;
      --h: 190px;
      --d: 56px;
      position:absolute;
      left:50%; top:50%;
      transform: translate(-50%,-50%);
      transform-style: preserve-3d;
    }
    .eface{
      position:absolute;
      left:50%; top:50%;
      border-radius: 22px;
      border: 1px solid rgba(0,0,0,.16);
      overflow:hidden;
      background: linear-gradient(180deg, #f6e6ea 0%, #e7bcc8 100%);
    }
    .eface::before{
      content:"";
      position:absolute; inset:0;
      background:
        url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='220' height='220'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='.78' numOctaves='2' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='220' height='220' filter='url(%23n)' opacity='.14'/%3E%3C/svg%3E") repeat;
      mix-blend-mode:multiply; opacity:.55; transform: scale(1.06);
      pointer-events:none;
    }
    .eface.front, .eface.back{ width: var(--w); height: var(--h); }
    .eface.left, .eface.right{ width: var(--d); height: var(--h); background: linear-gradient(180deg, #d9a9b8, #b98797); }
    .eface.top, .eface.bottom{ width: var(--w); height: var(--d); background: linear-gradient(180deg, #eec4d1, #c99aa9); }

    .eface.front  { transform: translate(-50%,-50%) rotateY(0deg)   translateZ(calc(var(--d)/2)); }
    .eface.back   { transform: translate(-50%,-50%) rotateY(180deg) translateZ(calc(var(--d)/2)); background: linear-gradient(180deg, #f1d3dc, #d9a9b8); }
    .eface.right  { transform: translate(-50%,-50%) rotateY(90deg)  translateZ(calc(var(--w)/2)); }
    .eface.left   { transform: translate(-50%,-50%) rotateY(-90deg) translateZ(calc(var(--w)/2)); }
    .eface.top    { transform: translate(-50%,-50%) rotateX(90deg)  translateZ(calc(var(--h)/2)); }
    .eface.bottom { transform: translate(-50%,-50%) rotateX(-90deg) translateZ(calc(var(--h)/2)); }

    .envFrontUI{ position:absolute; inset:0; }

    .envFlap{
      position:absolute; left: 10%; right:10%; top: 10%;
      height: 56%;
      border-radius: 18px;
      background: linear-gradient(180deg, rgba(255,255,255,.44), rgba(0,0,0,.06));
      clip-path: polygon(50% 86%, 0% 0%, 100% 0%);
      opacity:.92;
      transform-origin: 50% 0%;
      transform: rotateX(0deg);
      transition: transform .78s cubic-bezier(.2,.8,.2,1), opacity .78s cubic-bezier(.2,.8,.2,1);
    }
    .env3d.opened .envFlap{
      transform: rotateX(62deg) translateY(-6px);
      opacity:.80;
    }

    .seal{
      position:absolute; left:50%; top: 58%;
      width: 84px; height: 84px;
      transform: translate(-50%,-50%);
      border-radius: 24px;
      background: linear-gradient(180deg, #ff6c90, #ff3f73);
      border: 1px solid rgba(0,0,0,.18);
      box-shadow: 0 16px 22px rgba(0,0,0,.22);
      display:flex; align-items:center; justify-content:center;
      cursor:pointer;
      touch-action: manipulation;
    }
    .seal b{color: rgba(20,10,14,.72); font-size:18px; font-weight:950;}
    .seal.wiggle{ animation: sealWiggle .35s ease; }
    @keyframes sealWiggle{
      0%{transform:translate(-50%,-50%) rotate(0)}
      30%{transform:translate(-50%,-50%) rotate(-6deg)}
      65%{transform:translate(-50%,-50%) rotate(6deg)}
      100%{transform:translate(-50%,-50%) rotate(0)}
    }
    .seal.pulse{ animation: sealPulse 1.15s ease-in-out infinite; }
    @keyframes sealPulse{
      0%,100%{transform: translate(-50%,-50%) scale(1)}
      50%{transform: translate(-50%,-50%) scale(1.07)}
    }

    /* Reels */
    .reels{
      display:grid;
      grid-template-columns: 1fr 1.2fr 1fr;
      gap: 10px;
    }
    .reel{
      position:relative;
      height: 160px;
      border-radius: 22px;
      overflow:hidden;
      border: 1px solid rgba(0,0,0,.14);
      background: linear-gradient(180deg, rgba(255,255,255,.88), rgba(240,235,220,.96));
      box-shadow: 0 12px 22px rgba(0,0,0,.14);
      touch-action: none;
    }
    .reel::before{
      content:"";
      position:absolute; inset:0;
      background:
        url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='180' height='180'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='.9' numOctaves='2' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='180' height='180' filter='url(%23n)' opacity='.14'/%3E%3C/svg%3E") repeat;
      mix-blend-mode:multiply;
      opacity:.40;
      pointer-events:none;
    }
    .reelHeader{
      position:absolute; top: 10px; left:10px; right:10px;
      font-weight: 950;
      font-size: 12px;
      color: rgba(30,30,34,.62);
      text-align:center;
      pointer-events:none;
    }
    .windowLine{
      position:absolute; left:10px; right:10px; top: 50%;
      height: 46px;
      transform: translateY(-50%);
      border-radius: 16px;
      border: 1px dashed rgba(20,20,26,.25);
      background: rgba(255,255,255,.50);
      pointer-events:none;
    }
    .reelList{
      position:absolute; left:0; right:0; top:0; bottom:0;
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      gap: 18px;
      padding: 24px 10px;
      transform: translateY(0);
      will-change: transform;
    }
    .reelItem{
      font-weight: 950;
      font-size: 18px;
      color: rgba(20,20,26,.86);
      text-align:center;
      letter-spacing:.4px;
      min-height: 22px;
      padding: 2px 6px;
      border-radius: 10px;
    }
    .reelItem.dim{opacity:.38; filter: blur(.1px);}
    .lockFooter{display:flex; gap:10px;}
    .lockFooter .btn{flex:1}

    /* Letter (notebook) */
    .notebook{
      width:min(390px,100%);
      padding: 16px 16px 14px 16px;
      border-radius: 22px;
      border: 1px solid rgba(0,0,0,.14);
      box-shadow: var(--shadow);
      background:
        linear-gradient(90deg, rgba(255,75,115,.55) 0 2px, rgba(0,0,0,0) 2px) 34px 0/100% 100% no-repeat,
        repeating-linear-gradient(
          to bottom,
          rgba(80,150,255,.26) 0px,
          rgba(80,150,255,.26) 1px,
          rgba(0,0,0,0) 22px,
          rgba(0,0,0,0) 26px
        ),
        linear-gradient(180deg, #fbfaf6, #f1eadc);
      color: rgba(20,20,24,.88);
      position:relative;
      overflow:hidden;
    }
    .notebook::before{
      content:"";
      position:absolute; inset:0;
      background:
        url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='180' height='180'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='.85' numOctaves='2' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='180' height='180' filter='url(%23n)' opacity='.14'/%3E%3C/svg%3E") repeat;
      mix-blend-mode:multiply;
      opacity:.35;
      pointer-events:none;
    }
    .noteTitle{
      font-weight: 950;
      font-size: 16px;
      margin: 0 0 10px 0;
      padding-left: 22px;
    }
    .noteText{
      padding-left: 22px;
      font-weight: 900;
      font-size: 14px;
      line-height: 1.55;
      letter-spacing:.1px;
    }
    .noteText div{ margin: 2px 0; }

    .foot{
      display:flex; justify-content:center;
      color: rgba(255,255,255,.50);
      font-weight:800;
      font-size:11px;
      padding-bottom: 2px;
    }

    /* Loader */
    .loader{
      position:fixed; inset:0; z-index:90;
      display:flex; align-items:center; justify-content:center;
      background: linear-gradient(180deg, #101116, #08080b);
      transition: opacity .45s ease, transform .55s ease;
    }
    .loader.hide{opacity:0; pointer-events:none; transform: translateY(-6px);}
    .loaderCard{
      width: min(380px, 92vw);
      padding: 16px;
      border-radius: 28px;
      background: linear-gradient(180deg, #f3f0e7, #ebe3d5);
      border: 1px solid rgba(0,0,0,.12);
      box-shadow: var(--shadow);
      text-align:center;
      color: rgba(20,20,24,.88);
      position:relative;
      overflow:hidden;
    }
    .loaderCard::before{
      content:"";
      position:absolute; inset:0; pointer-events:none;
      background:
        url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='180' height='180'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='.85' numOctaves='2' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='180' height='180' filter='url(%23n)' opacity='.16'/%3E%3C/svg%3E") repeat;
      mix-blend-mode:multiply; opacity:.35;
    }
    .loaderTitle{font-weight: 950; font-size:16px; margin-bottom:6px;}
    .loaderSub{font-weight: 850; font-size:12px; color: rgba(20,20,24,.70); margin-bottom:14px; line-height:1.25;}
    .bar{
      height: 12px; border-radius: 999px;
      background: rgba(0,0,0,.08);
      border: 1px solid rgba(0,0,0,.10);
      overflow:hidden;
      box-shadow: inset 0 2px 0 rgba(255,255,255,.10);
    }
    .bar > i{
      display:block; height:100%; width:0%;
      border-radius: 999px;
      background: linear-gradient(180deg, rgba(255,179,199,.95), rgba(255,179,199,.70));
      transition: width .22s ease;
    }
    .tapToStart{
      margin-top: 12px;
      padding: 10px 12px;
      border-radius: 20px;
      background: linear-gradient(180deg, rgba(255,179,199,.75), rgba(255,179,199,.55));
      border: 1px solid rgba(0,0,0,.10);
      font-weight: 950;
      font-size: 12px;
      display:inline-flex; align-items:center; gap:10px;
      opacity:0; transform: translateY(6px);
      transition: opacity .35s ease, transform .45s cubic-bezier(.2,.8,.2,1);
    }
    .tapToStart.show{opacity:1; transform: translateY(0);}
    .tapDot{
      width:10px;height:10px;border-radius:999px;
      background: rgba(255,77,125,.95);
      box-shadow: 0 0 0 6px rgba(255,77,125,.12);
      animation: tapPulse 1.1s infinite ease-in-out;
    }
    @keyframes tapPulse{0%,100%{transform: scale(1)}50%{transform: scale(1.35)}}

    /* FX canvases */
    canvas#fx{
      position:absolute; inset:0; pointer-events:none; z-index: 6;
      width:100%;
      height:100%;
    }
    canvas#pix{
      position:absolute; inset:0; pointer-events:none; z-index:7;
      width:100%; height:100%;
      image-rendering: pixelated;
      opacity:.12;
      mix-blend-mode: overlay; /* –µ—Å–ª–∏ –≤ —Ç–µ–ª–µ–≥–µ —Å—Ç—Ä–∞–Ω–Ω–æ ‚Äî –ø–æ—Å—Ç–∞–≤—å normal */
    }

    /* Envelope "fly out" (arc) */
    .envPull{
      position:absolute;
      left:50%; top:64%;
      transform: translate(-50%,-50%) scale(.76);
      opacity:0;
      pointer-events:none;
      z-index: 9;
      filter: drop-shadow(0 26px 26px rgba(0,0,0,.40));
      pointer-events: none;
    }
    .envPull.fly{
      opacity:1;
      animation: envArc 900ms cubic-bezier(.18,.88,.16,1) both;
    }
    @keyframes envArc{
      0%{
        transform: translate(-50%,-50%) translate(0, 30px) rotateZ(0deg) rotateY(-14deg) scale(.76);
        opacity:0;
      }
      30%{ opacity:1; }
      100%{
        transform: translate(-50%,-50%) translate(0, -72px) rotateZ(-10deg) rotateY(14deg) scale(.92);
        opacity:1;
      }
    }

    /* Letter slide out from envelope */
    .letterSlide{
      position:absolute;
      left:50%;
      top:50%;
      width:min(390px, 92%);
      transform: translate(-50%,-50%) translateY(34px) scale(.92);
      opacity:0;
      pointer-events:none;
      z-index: 12;
      filter: drop-shadow(0 22px 22px rgba(0,0,0,.35));
    }
    .letterSlide.show{
      pointer-events:auto; /* –ª–æ–≤–∏—Ç –∫–ª–∏–∫–∏ –¢–û–õ–¨–ö–û –∫–æ–≥–¥–∞ –ø–∏—Å—å–º–æ –ø–æ–∫–∞–∑–∞–Ω–æ */
    }
    .letterSlide.show{
      opacity:1;
      animation: letterOut 950ms cubic-bezier(.18,.88,.16,1) both;
    }
    @keyframes letterOut{
      0%{
        transform: translate(-50%,-50%) translateY(70px) scale(.92);
        opacity:0;
      }
      25%{opacity:1;}
      100%{
        transform: translate(-50%,-50%) translateY(0px) scale(1);
        opacity:1;
      }
    }

    /* Center insult overlay */
    .centerMsg{
      position:absolute; inset:0;
      display:flex; align-items:center; justify-content:center;
      z-index: 30;
      pointer-events:none;
      opacity:0;
      transition: opacity .22s ease;
    }
    .scene{
      padding-top: 70px; /* —Ä–µ–∑–µ—Ä–≤ –ø–æ–¥ –≤–µ—Ä—Ö–Ω–∏–π –ø—É–∑—ã—Ä—å */
    }

    .scene > .bubble{
    position:absolute;
    top: 14px;
    left: 14px;
    right: 14px;
    margin: 0 auto;
    max-width: 92%;
    z-index: 20;
  }
  /* FIX step1 buttons */
    #step1 .row{ flex-wrap: nowrap; }
    #step1 .btn.wide{
      min-width: 0;
      flex: 1 1 0;
    }
  .modalWrap{ z-index: 10; } /* <-- –¥–æ–±–∞–≤—å (–∏–ª–∏ –ø—Ä–æ–≤–µ—Ä—å —á—Ç–æ —Ç–∞–∫) */
    .centerMsg.show{opacity:1;}
    .centerMsgBox{
      max-width: 92%;
      padding: 12px 14px;
      border-radius: 22px;
      background: linear-gradient(180deg, #f3f0e7, #ebe3d5);
      border: 1px solid rgba(0,0,0,.12);
      box-shadow: var(--shadow2);
      color: rgba(20,20,24,.88);
      font-weight: 950;
      text-align:center;
    }
    #boxWrap{ position: relative; }

    #boxWrap{
      position: relative;
    }

    #boxObj{
      position: relative;
      z-index: 5;   /* –∫–æ—Ä–æ–±–∫–∞ */
    }

    /* –ù–ï —Ç—Ä–æ–≥–∞–µ–º position, —á—Ç–æ–±—ã —Ä–∞–±–æ—Ç–∞–ª–∞ —Ç—Ä–∞–µ–∫—Ç–æ—Ä–∏—è envArc */
    #envPullReal{
      z-index: 10;         /* –ø—Ä–æ—Å—Ç–æ –≤—ã—à–µ –∫–æ—Ä–æ–±–∫–∏ */
      position: absolute;  /* –Ω–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π —Ñ–∏–∫—Å–∏—Ä—É–µ–º –∞–±—Å–æ–ª—é—Ç */
      left: 50%;
      top: 64%;
    }
    /* cheap barrel-ish feel */
    .viewport{
      transform: translateZ(0) perspective(900px) rotateX(.6deg) scale(1.012);
      transform-origin: 50% 50%;
    }
    #signModal{
      border-radius: 30px;   /* —Å—Ç–µ–ø–µ–Ω—å –∑–∞–∫—Ä—É–≥–ª–µ–Ω–∏—è */
      overflow: hidden;      /* —á—Ç–æ–±—ã —Ñ–æ–Ω –Ω–µ –≤—ã—Ö–æ–¥–∏–ª –∑–∞ –∫—Ä–∞—è */
    }
    /* –∫–æ–Ω–≤–µ—Ä—Ç –ø–∞–¥–∞–µ—Ç –≤–Ω–∏–∑ */
    #envWrap.drop{
      animation: envDrop 520ms cubic-bezier(.18,.88,.16,1) both;
    }
    @keyframes envDrop{
      from { transform: translateY(0); }
      to   { transform: translateY(30px); }
    }
    /* cinematic auto-focus for envelope */
    #envObj.autofocus{
      transition: transform 520ms cubic-bezier(.2,.9,.2,1);
    }
    #sealBtn.press{
      transition: transform 220ms cubic-bezier(.2,.9,.2,1);
      transform: translate(-50%,-50%) scale(.94);
    }
    .loaderImg{
      display:block;
      width:min(240px, 70vw);
      height:auto;
      margin: 0 auto 10px auto;

      border-radius:22px;
      border:1px solid rgba(0,0,0,.12);
      box-shadow:0 14px 22px rgba(0,0,0,.18);

      object-fit:cover;
    }
    @media (prefers-reduced-motion: reduce){
      *{animation:none !important; transition:none !important;}
    }

    .loader{
      touch-action: none;
    }
  </style>
</head>

<body>
  <div class="loader" id="loader">
    <div class="loaderCard">
      <img class="loaderImg" src="Images/jama.png" alt="Jama">
      <div class="loaderTitle">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
      <div class="loaderSub">–¢–∞–ø–Ω–∏ –Ω–∞ —ç–∫—Ä–∞–Ω, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å :)</div>
      <div class="bar"><i id="barFill"></i></div>
      <div class="tapToStart" id="tapToStart"><span class="tapDot"></span>–¢–∞–ø–Ω–∏, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å</div>
    </div>
  </div>

  <div id="app">
    <div class="stage">

      <div class="viewport" id="viewport">
        <canvas id="fx"></canvas>
        <canvas id="pix"></canvas>

        <!-- STEP 1: courier (REPLACEMENT v2) -->
        <section class="scene active" id="step1">
          <div class="bubble" id="courierBubble">
            <div class="who" id="courierWho">–°–Ω–∞—Ä—É–∂–∏</div>
            <div class="txt" id="courierText">*–¢—É–∫ —Ç—É–∫*</div>
          </div>

          <div class="center">
            <div class="objectStage">

              <!-- Center action modal (single) -->
              <div class="modalWrap show" id="signModal"
                   style="background:
                     radial-gradient(520px 320px at 50% 35%, rgba(255,255,255,.06), rgba(0,0,0,0) 62%),
                     radial-gradient(720px 420px at 50% 120%, rgba(255,77,125,.10), rgba(0,0,0,0) 58%),
                     rgba(0,0,0,.45);
                   ">
                <div class="modal paper" style="position:relative;">
                  <h3 id="actionTitle">–û—Ç–∫—Ä—ã—Ç—å –¥–≤–µ—Ä—å?</h3>
                  <p id="actionSub">–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ</p>

                  <div class="row" id="actionButtons">
                    <button class="btn ghost wide" id="btnNo">–ù–µ—Ç</button>
                    <button class="btn primary wide" id="btnYes">–î–∞</button>
                  </div>
                </div>
              </div>

            </div>
          </div>
        </section>

        <!-- STEP 2: box + lock -->
        <section class="scene" id="step2">
          <div class="bubble small" id="boxBubble">
            <div class="who">–°–æ–≤–µ—Ç—á–∏–∫</div>
            <div class="txt">–ü–æ–∫—Ä—É—Ç–∏ –∫–æ—Ä–æ–±–∫—É –ø–∞–ª—å—Ü–µ–º –∏ –Ω–∞–∂–º–∏ –Ω–∞ –∑–∞–º–æ–∫.</div>
          </div>

          <div class="center">
            <div class="objectStage">
              <div class="objWrap" id="boxWrap">
                <div class="obj" id="boxObj">
                  <div class="box3d" id="box3d">
                    <div class="bface front" id="boxFront">
                      <div class="label">–¥–ª—è –ü—É–ø—Å–∏–∫–∞ <small>–æ—Ç —Ñ–∞–Ω–∞—Ç–∞ üòâ</small></div>
                      <div class="tape"></div>

                      <div class="lock3d pulse" id="lockBtn" aria-label="lock">
                        <div class="lockBack"></div>
                        <div class="lockSide"></div>
                        <div class="lockSide r"></div>
                        <div class="lockBody"></div>
                        <div class="lockShackle"></div>
                        <div class="lockKeyhole"></div>
                      </div>
                    </div>

                    <div class="bface back"></div>
                    <div class="bface right"></div>
                    <div class="bface left"></div>
                    <div class="bface top" id="boxTop"></div>
                    <div class="bface bottom"></div>
                  </div>
                </div>
                <div class="pixelFrame"></div>

                <!-- real preview envelope (3D) -->
                <div class="envPull" id="envPullReal">
                  <div class="env3d">
                    <div class="eface front">
                      <div class="envFrontUI">
                        <div class="envFlap"></div>
                        <div class="seal" style="top:60%;"><b>‚ô•</b></div>
                      </div>
                    </div>
                    <div class="eface back"></div>
                    <div class="eface right"></div>
                    <div class="eface left"></div>
                    <div class="eface top"></div>
                    <div class="eface bottom"></div>
                  </div>
                </div>

              </div>

              <div class="modalWrap" id="lockModal">
                <div class="modal paper">
                  <h3>–ß—Ç–æ–±—ã –æ—Ç–∫—Ä—ã—Ç—å, –≤–≤–µ–¥–∏ –¥–∞—Ç—É –¥–Ω—è –≤–ª—é–±–ª–µ–Ω–Ω—ã—Ö –≤ —ç—Ç–æ—Ç —Ä–∞–∑</h3>
                  <p>–°–≤–∞–π–ø–∞–π –≤–≤–µ—Ä—Ö/–≤–Ω–∏–∑ –Ω–∞ –∫–æ–ª—ë—Å–∏–∫–∞—Ö. –ü–æ—Ç–æ–º –Ω–∞–∂–º–∏ ‚Äú–ì–æ—Ç–æ–≤–æ‚Äù.</p>

                  <div class="reels" id="reels">
                    <div class="reel" data-reel="day">
                      <div class="reelHeader"></div>
                      <div class="windowLine"></div>
                      <div class="reelList" id="reelDay"></div>
                    </div>
                    <div class="reel" data-reel="month">
                      <div class="reelHeader"></div>
                      <div class="windowLine"></div>
                      <div class="reelList" id="reelMonth"></div>
                    </div>
                    <div class="reel" data-reel="year">
                      <div class="reelHeader"></div>
                      <div class="windowLine"></div>
                      <div class="reelList" id="reelYear"></div>
                    </div>
                  </div>

                  <div class="lockFooter" style="margin-top:12px;">
                    <button class="btn ghost" id="lockBack">–ù–∞–∑–∞–¥</button>
                    <button class="btn primary" id="lockDone">–ì–æ—Ç–æ–≤–æ</button>
                  </div>
                </div>
              </div>

            </div>
          </div>

          <div class="row">
            <button class="btn ghost wide" id="boxReset">–°–±—Ä–æ—Å–∏—Ç—å –≤—Ä–∞—â–µ–Ω–∏–µ</button>
          </div>
        </section>

        <!-- STEP 3: envelope + letter slide -->
        <section class="scene" id="step3">
          <div class="bubble small" id="envBubble">
            <div class="who">–°–æ–≤–µ—Ç—á–∏–∫</div>
            <div class="txt" id="envHint">–ù–∞–∂–º–∏ –Ω–∞ –ø–µ—á–∞—Ç—å. –û–Ω–∞ —Å ‚Äú–∑–∞–º–∫–æ–º‚Äù.</div>
          </div>

          <div class="center">
            <div class="objectStage">

              <div class="centerMsg" id="centerMsg">
                <div class="centerMsgBox" id="centerMsgBox"></div>
              </div>

              <div class="objWrap" id="envWrap">
                <div class="obj" id="envObj">
                  <div class="env3d" id="env3d">
                    <div class="eface front">
                      <div class="envFrontUI">
                        <div class="envFlap" id="flap"></div>
                        <div class="seal pulse" id="sealBtn" aria-label="seal"><b>‚ô•</b></div>
                      </div>
                    </div>
                    <div class="eface back"></div>
                    <div class="eface right"></div>
                    <div class="eface left"></div>
                    <div class="eface top"></div>
                    <div class="eface bottom"></div>
                  </div>
                </div>
                <div class="pixelFrame"></div>

                <!-- Letter slides out (no modal) -->
                <div class="letterSlide" id="letterSlide">
                  <div class="notebook">
                    <div class="noteTitle">–°–µ–∫—Å–∏ –ø–∏—Å—å–º–æ</div>
                    <div class="noteText" id="letterText">
                      <div>‚ô•‚ô•‚ô•‚ô•‚ô•‚ô•‚ô•‚ô•‚ô•‚ô•‚ô•‚ô•‚ô•‚ô•</div>
                      <div>–£—Ñ –¥–µ—Ç–∫–∞, –ø—Ä–∏–≤–µ—Ç</div>
                      <div>–î–æ –¥–æ –¥–æ, —è —Ç–∞–∫–æ–π –∫—Ä—É—Ç–æ–π</div>
                      <div>–ê –µ—â–µ —É –º–µ–Ω—è –ø–∏—Å—é–Ω –¥–æ –Ω–µ–±–µ—Å</div>
                      <div>–¢–∏—à–µ –µ–¥–µ—à—å –¥–∞–ª—å—à–µ –±—É–¥–µ—à—å</div>
                      <div>–ü—É—Å—Ç—å —Ñ–∞—Ä–∞–º –±—É–¥–µ—Ç –±—É–¥–µ—Ç —Ç–µ–ø–ª–æ,</div>
                      <div>–¥–∞–∂–µ –∫–æ–≥–¥–∞ –≤–æ–∫—Ä—É–≥ —Ö–æ–ª–æ–¥–Ω–æ.</div>
                      <div>‚ô•‚ô•‚ô•‚ô•‚ô•‚ô•‚ô•‚ô•‚ô•‚ô•‚ô•‚ô•‚ô•‚ô•</div>
                    </div>
                    <div class="row" style="margin-top:14px;">
                      <button class="btn primary wide" id="restart">‚ô•–ü–µ—Å—é–Ω‚ô•</button>
                    </div>
                    <div class="row" style="margin-top:10px;">
                      <button class="btn ghost wide" id="saveLetterBtn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Envelope lock modal (DOB) -->
              <div class="modalWrap" id="envLockModal">
                <div class="modal paper">
                  <h3>–ß—Ç–æ–±—ã –æ—Ç–∫—Ä—ã—Ç—å –Ω—É–∂–Ω–∞ –í–∞—à–∞ –¥–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è –∏–∑ —Ç–≥ ;)</h3>
                  <p>–°–≤–∞–π–ø–∞–π –≤–≤–µ—Ä—Ö/–≤–Ω–∏–∑ –Ω–∞ –∫–æ–ª—ë—Å–∏–∫–∞—Ö. –ü–æ—Ç–æ–º –Ω–∞–∂–º–∏ ‚Äú–ì–æ—Ç–æ–≤–æ‚Äù.</p>

                  <div class="reels" id="envReels">
                    <div class="reel" data-reel="day">
                      <div class="reelHeader"></div>
                      <div class="windowLine"></div>
                      <div class="reelList" id="envReelDay"></div>
                    </div>
                    <div class="reel" data-reel="month">
                      <div class="reelHeader"></div>
                      <div class="windowLine"></div>
                      <div class="reelList" id="envReelMonth"></div>
                    </div>
                    <div class="reel" data-reel="year">
                      <div class="reelHeader"></div>
                      <div class="windowLine"></div>
                      <div class="reelList" id="envReelYear"></div>
                    </div>
                  </div>

                  <div class="lockFooter" style="margin-top:12px;">
                    <button class="btn ghost" id="envLockBack">–ù–∞–∑–∞–¥</button>
                    <button class="btn primary" id="envLockDone">–ì–æ—Ç–æ–≤–æ</button>
                  </div>
                </div>
              </div>

            </div>
          </div>

          <div class="row" id="envButtons">
            <button class="btn danger wide" id="throwBtn">–í—ã–±—Ä–æ—Å–∏—Ç—å</button>
          </div>
        </section>

      </div>

      <div class="foot">–ü–æ–¥–∞—Ä–æ—á–Ω–∞—è –∏–≥—Ä–∞ –ø–æ–ª–Ω–æ—Å—Ç—å—é –ø—Ä–µ–Ω–∞–¥–ª–µ–∂–∏—Ç –õ–æ—à–∞—Ä–µ</div>
    </div>
  </div>

  <div class="crt" aria-hidden="true"></div>
  <div class="crtMask" aria-hidden="true"></div>
  <div class="pxGrid" aria-hidden="true"></div>

  <script>
    /* =========================================================
       CONFIG
       ========================================================= */
    const CONFIG = {
      audio: {
        bgm: "Images/undertail.mp3",
        click: "Audio/click.mp3",
        paper: "Audio/paper.mp3",
        lock: "Audio/lock.mp3",
        success: "Audio/success.mp3",
        wrong: "Audio/wrong.mp3",
        whoosh: "Audio/whoosh.mp3"
      },
      // –∫–æ—Ä–æ–±–∫–∞: –¥–∞—Ç–∞ –Ω–∞—á–∞–ª–∞ –æ—Ç–Ω–æ—à–µ–Ω–∏–π (–ø—Ä–∏–º–µ—Ä)
      boxLock: { day: 14, monthIndex: 1, year: 2026 },

      // –∫–æ–Ω–≤–µ—Ä—Ç: –î–† —Ñ–∞–Ω–∞—Ç–∞ = 1 —Ñ–µ–≤—Ä–∞–ª—è 2005
      envLock: { day: 28, monthIndex: 11, year: 2006 },

      maxParticles: 90
    };

    const $ = (id)=>document.getElementById(id);
    const clamp = (v,a,b)=>Math.max(a, Math.min(b,v));
    const lerp = (a,b,t)=>a+(b-a)*t;
    const now = ()=>performance.now();

    /* =========================================================
       Audio
       ========================================================= */
    class AudioEngine{
      constructor(){
        this.ctx=null; this.unlocked=false;
        this.buffers=new Map();
        this.bgmEl=null;
        this.bgmGain=0.01;
        this.sfxGain=0.70;
        this.master=null; this.sfxBus=null;

        // FIX: –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –∑–∞–≤–µ—Å—Ç–∏ bgmBus
        this.bgmBus = null;

        this.bgmSource = null;
      }

      async init(){
        if (this.ctx) return;
        const AC = window.AudioContext || window.webkitAudioContext;
        if (!AC) return;

        this.ctx = new AC();

        this.master = this.ctx.createGain();
        this.master.gain.value = 0.85;
        this.master.connect(this.ctx.destination);

        this.sfxBus = this.ctx.createGain();
        this.sfxBus.gain.value = this.sfxGain;
        this.sfxBus.connect(this.master);

        // FIX: BGM —à–∏–Ω–∞
        this.bgmBus = this.ctx.createGain();
        this.bgmBus.gain.value = this.bgmGain;
        this.bgmBus.connect(this.master);

        const sfxKeys = ["click","paper","lock","success","wrong","whoosh"];
        await Promise.all(sfxKeys.map(k=>this._tryLoadBuffer(k, CONFIG.audio[k])));
      }

      async unlock(){
        if (!this.ctx) await this.init();
        if (!this.ctx) return;

        try{ if (this.ctx.state!=="running") await this.ctx.resume(); }catch(e){}
        this._beep(0.0001,220,0.01,0);
        this.unlocked=true;
        this.startBGM();
      }

      async _tryLoadBuffer(key,url){
        if (!url) return;
        try{
          const res = await fetch(url, {cache:"force-cache"});
          if (!res.ok) return;
          const arr = await res.arrayBuffer();
          const buf = await this.ctx.decodeAudioData(arr);
          this.buffers.set(key, buf);
        }catch(e){}
      }

      _playBuffer(key, vol=1){
        if (!this.ctx || !this.unlocked) return false;
        const buf = this.buffers.get(key);
        if (!buf) return false;

        const src = this.ctx.createBufferSource();
        const g = this.ctx.createGain();
        g.gain.value = vol;

        src.buffer = buf;
        src.connect(g);
        g.connect(this.sfxBus);
        src.start();
        return true;
      }

      _beep(vol,freq,dur,type=0){
        if (!this.ctx || !this.unlocked) return;
        const osc = this.ctx.createOscillator();
        const g = this.ctx.createGain();
        osc.type = type===0 ? "sine" : (type===1 ? "triangle" : "square");
        osc.frequency.value = freq;
        g.gain.value = 0;
        osc.connect(g); g.connect(this.sfxBus);

        const t0 = this.ctx.currentTime;
        g.gain.setValueAtTime(0, t0);
        g.gain.linearRampToValueAtTime(vol, t0+0.01);
        g.gain.exponentialRampToValueAtTime(0.0001, t0+dur);

        osc.start(t0);
        osc.stop(t0+dur+0.02);
      }

      sfx(name){
        const ok = this._playBuffer(name,1);
        if (ok || !this.unlocked) return;

        switch(name){
          case "click":  this._beep(0.06,520,0.06,1); this._beep(0.03,760,0.04,0); break;
          case "paper":  this._beep(0.03,240,0.06,1); this._beep(0.02,310,0.05,1); this._beep(0.02,420,0.05,1); break;
          case "lock":   this._beep(0.06,220,0.08,1); this._beep(0.05,320,0.10,0); break;
          case "wrong":  this._beep(0.05,180,0.10,2); this._beep(0.04,140,0.10,2); break;
          case "success":this._beep(0.06,520,0.08,0); this._beep(0.05,660,0.10,1); this._beep(0.04,820,0.12,0); break;
          case "whoosh": this._beep(0.03,240,0.18,1); this._beep(0.02,180,0.20,1); break;
          case "sparkle":
            this._beep(0.03, 520, 0.06, 1);
            setTimeout(()=>this._beep(0.035, 740, 0.06, 1), 70);
            setTimeout(()=>this._beep(0.04, 980, 0.07, 0), 140);
            setTimeout(()=>this._beep(0.055, 1220, 0.08, 0), 210);
            setTimeout(()=>this._beep(0.05, 420, 0.10, 2), 300);
            setTimeout(()=>this._beep(0.045, 260, 0.14, 2), 360);
            break;
        }
      }

      async startBGM(){
        if (!this.unlocked) return;
        const url = CONFIG.audio.bgm;
        if (!url || !this.ctx) return;

        if (!this.bgmEl){
          this.bgmEl = new Audio(url);
          this.bgmEl.loop = true;
          this.bgmEl.preload = "auto";
          this.bgmEl.playsInline = true;
          this.bgmEl.volume = 1;
        }

        // FIX: –µ—Å–ª–∏ bgmBus –Ω–µ —Å–æ–∑–¥–∞–Ω (–Ω–∞ –≤—Å—è–∫–∏–π) ‚Äî –Ω–µ –ø–∞–¥–∞–µ–º
        if (!this.bgmBus){
          this.bgmEl.volume = this.bgmGain;
          try{ await this.bgmEl.play(); }catch(e){}
          return;
        }

        if (!this.bgmSource){
          try{
            this.bgmSource = this.ctx.createMediaElementSource(this.bgmEl);
            this.bgmSource.connect(this.bgmBus);
          }catch(e){
            this.bgmEl.volume = this.bgmGain;
          }
        }

        this.bgmBus.gain.value = this.bgmGain;

        try{ await this.bgmEl.play(); }catch(e){}
      }
    } // <-- FIX: –∑–∞–∫—Ä—ã–≤–∞–µ–º –∫–ª–∞—Å—Å
    const audio = new AudioEngine();
    /* =========================================================
       Loader
       ========================================================= */
    const loader = $("loader");
    const barFill = $("barFill");
    const tapToStart = $("tapToStart");
    const PRELOAD = { set(p){ barFill.style.width = `${Math.round(p*100)}%`; } };

    async function preload(){
      PRELOAD.set(0);
      PRELOAD.set(1);
      tapToStart.classList.add("show");
    }

    /* =========================================================
       Steps
       ========================================================= */
    const steps = [$("step1"), $("step2"), $("step3")];
    let stepIndex = 0;
    function showStep(i){
      stepIndex = clamp(i,0,2);
      steps.forEach((s,idx)=>s.classList.toggle("active", idx===stepIndex));
      fx.resize();
      pix.resize();
    }

    /* =========================================================
       Inertial rotation
       ========================================================= */
    class InertialRotator{
      constructor(el, opts={}){
        this.el = el;
        this.dragging=false;

        this.rotX = opts.rotX ?? 12;
        this.rotY = opts.rotY ?? -18;
        this.vx=0; this.vy=0;

        this.scale = 1;
        this.scaleTarget = 1;

        this.maxSpeed=240;
        this.damping=11.2;
        this.spring=48;
        this.xMin=-12; this.xMax=24;

        this._px=0; this._py=0;
        this.lastT = now();

        this._down=(e)=>this.onDown(e);
        this._move=(e)=>this.onMove(e);
        this._up=()=>this.onUp();

        this.el.addEventListener("pointerdown", this._down, {passive:false});
        window.addEventListener("pointermove", this._move, {passive:false});
        window.addEventListener("pointerup", this._up, {passive:true});
        window.addEventListener("pointercancel", this._up, {passive:true});

        this.apply();
        this.loop();
      }
      reset(){
        this.rotX=12; this.rotY=-18; this.vx=this.vy=0;
        this.scale=this.scaleTarget=1;
        this.apply();
      }
      setScale(target){ this.scaleTarget = clamp(target, 0.90, 1.12); }
      onDown(e){
        if (e.isPrimary === false) return;
        const t = e.target;
        if (t.closest && (t.closest("#lockBtn") || t.closest("#sealBtn") || t.closest("button"))) return;

        this.dragging=true;
        this.el.setPointerCapture?.(e.pointerId);
        this._px=e.clientX; this._py=e.clientY;
        this.vx=this.vy=0;
        audio.sfx("click");
        e.preventDefault();
      }
      onMove(e){
        if (!this.dragging) return;
        const dx=e.clientX - this._px;
        const dy=e.clientY - this._py;
        this._px=e.clientX; this._py=e.clientY;

        const scale=0.22;
        this.rotY += dx*scale;
        this.rotX -= dy*scale;

        const instantVX = (-dy*scale)*60;
        const instantVY = (dx*scale)*60;
        this.vx = clamp(lerp(this.vx, instantVX, 0.35), -this.maxSpeed, this.maxSpeed);
        this.vy = clamp(lerp(this.vy, instantVY, 0.35), -this.maxSpeed, this.maxSpeed);

        if (this.rotX < this.xMin) this.rotX = lerp(this.rotX, this.xMin, 0.35);
        if (this.rotX > this.xMax) this.rotX = lerp(this.rotX, this.xMax, 0.35);

        this.apply();
        e.preventDefault();
      }
      onUp(){
        if (!this.dragging) return;
        this.dragging=false;
        audio.sfx("paper");
      }
      loop(){
        const t=now();
        const dt=Math.min(0.033, (t-this.lastT)/1000);
        this.lastT=t;

        if (!this.dragging){
          const damp = Math.exp(-this.damping*dt);
          this.vx *= damp; this.vy *= damp;
          this.rotX += this.vx*dt;
          this.rotY += this.vy*dt;

          if (this.rotX < this.xMin){ this.vx += (this.xMin - this.rotX)*this.spring*dt; }
          else if (this.rotX > this.xMax){ this.vx += (this.xMax - this.rotX)*this.spring*dt; }

          this.vx = clamp(this.vx, -this.maxSpeed, this.maxSpeed);
          this.vy = clamp(this.vy, -this.maxSpeed, this.maxSpeed);

          if (Math.abs(this.vx) < 0.02) this.vx=0;
          if (Math.abs(this.vy) < 0.02) this.vy=0;
        }

        this.scale = lerp(this.scale, this.scaleTarget, 1 - Math.exp(-10*dt));
        this.apply();
        requestAnimationFrame(()=>this.loop());
      }
      apply(){
        this.el.style.transform =
          `translateZ(0) rotateX(${this.rotX.toFixed(2)}deg) rotateY(${this.rotY.toFixed(2)}deg) scale(${this.scale.toFixed(3)})`;
      }
    }

    /* =========================================================
       Reels
       ========================================================= */
    class Reel{
      constructor(rootEl, listEl, values, formatter){
        this.root=rootEl; this.list=listEl;
        this.values=values;
        this.formatter=formatter||((v)=>String(v));
        this.index=0;
        this.offset=0;
        this.velocity=0;
        this.dragging=false;

        this.itemGap=18;
        this.itemH=24;
        this.maxVel=1800;
        this.damping=12;
        this.snapK=85;

        this._py=0;
        this._lastT=now();

        this.populate();
        this.measure();

        this._down=(e)=>this.onDown(e);
        this._move=(e)=>this.onMove(e);
        this._up=()=>this.onUp();

        this.root.addEventListener("pointerdown", this._down, {passive:false});
        window.addEventListener("pointermove", this._move, {passive:false});
        window.addEventListener("pointerup", this._up, {passive:true});
        window.addEventListener("pointercancel", this._up, {passive:true});

        this.render();
        this.loop();
      }
      populate(){
        this.list.innerHTML="";
        for(let i=0;i<9;i++){
          const d=document.createElement("div");
          d.className="reelItem";
          this.list.appendChild(d);
        }
      }
      measure(){
        const first=this.list.querySelector(".reelItem");
        if (first){
          const r=first.getBoundingClientRect();
          if (r.height>0) this.itemH=r.height;
        }
      }
      setIndex(idx, quiet=false){
        const n=this.values.length;
        this.index=((idx%n)+n)%n;
        if(!quiet) audio.sfx("click");
        this.offset=0; this.velocity=0;
        this.render();
      }
      getValue(){ return this.values[this.index]; }

      onDown(e){
        if (e.isPrimary===false) return;
        this.dragging=true;
        this.root.setPointerCapture?.(e.pointerId);
        this._py=e.clientY;
        this.velocity=0;
        audio.sfx("click");
        e.preventDefault();
      }
      onMove(e){
        if(!this.dragging) return;
        const dy=e.clientY - this._py;
        this._py=e.clientY;

        this.offset += dy;
        this.velocity = clamp(lerp(this.velocity, dy*60, 0.35), -this.maxVel, this.maxVel);

        const step = this.itemH + this.itemGap;
        while(this.offset > step){
          this.offset -= step;
          this.index = (this.index - 1 + this.values.length) % this.values.length;
          audio.sfx("paper");
        }
        while(this.offset < -step){
          this.offset += step;
          this.index = (this.index + 1) % this.values.length;
          audio.sfx("paper");
        }
        this.render();
        e.preventDefault();
      }
      onUp(){
        if(!this.dragging) return;
        this.dragging=false;
        audio.sfx("paper");
      }
      loop(){
        const t=now();
        const dt=Math.min(0.033, (t-this._lastT)/1000);
        this._lastT=t;

        if(!this.dragging){
          const damp=Math.exp(-this.damping*dt);
          this.velocity *= damp;
          this.offset += this.velocity*dt;

          const step=this.itemH+this.itemGap;
          while(this.offset > step){ this.offset -= step; this.index = (this.index-1+this.values.length)%this.values.length; }
          while(this.offset < -step){ this.offset += step; this.index = (this.index+1)%this.values.length; }

          const snapForce = -this.offset * this.snapK;
          this.velocity += snapForce * dt;

          if(Math.abs(this.offset)<0.4 && Math.abs(this.velocity)<8){ this.offset=0; this.velocity=0; }
          this.render();
        }
        requestAnimationFrame(()=>this.loop());
      }
      render(){
        const items=[...this.list.children];
        const center=4;
        const n=this.values.length;
        for(let i=0;i<items.length;i++){
          const rel=i-center;
          const idx=(this.index+rel+n)%n;
          items[i].textContent=this.formatter(this.values[idx]);
          if(Math.abs(rel)>=3) items[i].classList.add("dim");
          else items[i].classList.remove("dim");
        }
        this.list.style.transform=`translateY(${this.offset}px)`;
      }
    }

    /* =========================================================
    FX particles (upgraded: burst from envelope, real "firework", optional slowmo)
    ========================================================= */
    class FX{
      constructor(canvas){
        this.c = canvas;
        this.ctx = canvas.getContext("2d", { alpha:true, desynchronized:true });
        this.w = 0; this.h = 0;
        this.dpr = Math.min(2, window.devicePixelRatio || 1);
        this.particles = [];
        this._last = now();
        this._raf = null;

        // optional: slow-motion multiplier (1 = normal)
        this.timeScale = 1;

        window.addEventListener("resize", ()=>this.resize(), {passive:true});
        this.resize();
      }

      resize(){
        const r = this.c.getBoundingClientRect();
        this.w = Math.max(1, Math.floor(r.width));
        this.h = Math.max(1, Math.floor(r.height));
        this.c.width  = Math.floor(this.w*this.dpr);
        this.c.height = Math.floor(this.h*this.dpr);
        this.ctx.setTransform(this.dpr,0,0,this.dpr,0,0);
      }

      // legacy call keeps working
      burst(kind="hearts"){
        this.burstAt(this.w*0.5, this.h*0.42, kind, 1);
      }

      // NEW: spawn at specific position (e.g., seal / envelope opening)
      burstAt(x, y, kind="hearts", power=1){
        const count = kind==="hearts" ? 42 : 64;
        const max = CONFIG.maxParticles;

        for(let i=0;i<count;i++){
          if(this.particles.length >= max) break;

          // mix: 55% narrow jet upwards, 45% radial ring
          const jet = i < count*0.55;
          const a = jet
            ? (-Math.PI/2 + (Math.random()*0.55 - 0.275)) // upward cone
            : (Math.random()*Math.PI*2);                  // full ring

          const base = (kind==="hearts" ? 240 : 320) * power;
          const sp = base + Math.random()*(kind==="hearts" ? 260 : 340) * power;

          const vx = Math.cos(a) * sp;
          const vy = Math.sin(a) * sp - (jet ? 260*power : 120*power);

          this.particles.push({
            x: x + (Math.random()*18 - 9),
            y: y + (Math.random()*16 - 8),
            vx, vy,
            g: (kind==="hearts" ? 520 : 620),
            life: 1,
            rot: Math.random() * Math.PI * 2,
            vr: (Math.random()*2 - 1) * (jet ? 10 : 7),
            s: kind==="hearts" ? (12 + Math.random()*12) : (7 + Math.random()*8),
            kind
          });
        }

        if(!this._raf) this.loop();
      }

      loop(){
        const t = now();
        const dt = Math.min(0.033, (t - this._last) / 1000);
        this._last = t;

        // apply slowmo multiplier
        const kdt = dt * this.timeScale;

        this.ctx.clearRect(0,0,this.w,this.h);

        for(let i=this.particles.length-1;i>=0;i--){
          const p = this.particles[i];

          p.vy   += p.g * kdt;
          p.x    += p.vx * kdt;
          p.y    += p.vy * kdt;
          p.rot  += p.vr * kdt;
          p.life -= kdt * (p.kind==="hearts" ? 0.55 : 0.72);

          const alpha = clamp(p.life, 0, 1);
          if(alpha <= 0 || p.y > this.h + 120){
            this.particles.splice(i,1);
            continue;
          }

          this.ctx.save();
          this.ctx.globalAlpha = alpha;
          this.ctx.translate(p.x, p.y);
          this.ctx.rotate(p.rot);

          if(p.kind==="hearts") this.drawHeart(0,0,p.s);
          else this.drawConfetti(0,0,p.s);

          this.ctx.restore();
        }

        if(this.particles.length > 0) this._raf = requestAnimationFrame(()=>this.loop());
        else this._raf = null;
      }

      drawHeart(x,y,s){
        const ctx=this.ctx;
        const t=s*0.3;
        ctx.beginPath();
        ctx.moveTo(x, y+t);
        ctx.bezierCurveTo(x, y, x-s/2, y, x-s/2, y+t);
        ctx.bezierCurveTo(x-s/2, y+(s+t)/2, x, y+(s+t)/1.2, x, y+s);
        ctx.bezierCurveTo(x, y+(s+t)/1.2, x+s/2, y+(s+t)/2, x+s/2, y+t);
        ctx.bezierCurveTo(x+s/2, y, x, y, x, y+t);
        ctx.closePath();
        ctx.fillStyle="rgba(255,179,199,.90)";
        ctx.fill();
        ctx.strokeStyle="rgba(0,0,0,.18)";
        ctx.lineWidth=1;
        ctx.stroke();
      }

      // upgraded confetti: thin strips instead of fat rectangles (looks like fireworks)
      drawConfetti(x,y,s){
        const ctx=this.ctx;
        ctx.save();
        ctx.rotate(Math.random()*0.2 - 0.1);
        ctx.beginPath();
        ctx.rect(x - s*0.12, y - s*0.9, s*0.24, s*1.8);
        ctx.fillStyle="rgba(255,179,199,.85)";
        ctx.fill();
        ctx.strokeStyle="rgba(0,0,0,.16)";
        ctx.lineWidth=1;
        ctx.stroke();
        ctx.restore();
      }
    }

    const fx = new FX($("fx"));

    /* =========================================================
   Pixel + CRT overlay (low-res blocks + rare scanlines + slight chroma noise)
   Drop-in replacement for your PixelOverlay
   ========================================================= */
    class PixelOverlay{
      constructor(canvas){
        this.c = canvas;
        this.ctx = canvas.getContext("2d", { alpha: true, desynchronized: true });

        // "render resolution" (smaller = more detailed, larger = chunkier)
        this.scale = 6;

        this.w = 1; this.h = 1;

        // line / noise controls
        this.scale = 4;          // —á—É—Ç—å –∫—Ä—É–ø–Ω–µ–µ –±–ª–æ–∫–∏
        this.baseAlpha = 55;     // –±—ã–ª–æ 120 (—Å–ª–∏—à–∫–æ–º –∂–∏—Ä–Ω–æ)
        this.lineProbBright = 0.008;
        this.lineProbDark   = 0.004;
        this.lineBurstProb  = 0.004;  // rare burst of a few lines (VHS-ish)

        // subtle time drift
        this.t = 0;

        // keep one ImageData buffer (avoid alloc each frame)
        this.img = null;

        this._raf = null;
        this._resize = ()=>this.resize();

        window.addEventListener("resize", this._resize, { passive: true });
        this.resize();
        this.loop();
      }

      resize(){
        const r = this.c.getBoundingClientRect();
        const w = Math.max(1, Math.floor(r.width / this.scale));
        const h = Math.max(1, Math.floor(r.height / this.scale));

        if (w === this.w && h === this.h && this.img) return;

        this.w = w; this.h = h;
        this.c.width  = w;
        this.c.height = h;

        // IMPORTANT: disable smoothing so CSS upscale looks "pixelated"
        this.ctx.imageSmoothingEnabled = false;

        // allocate once
        this.img = this.ctx.createImageData(this.w, this.h);
      }

      // small helper
      _clampByte(v){ return v < 0 ? 0 : (v > 255 ? 255 : v|0); }

      loop(){
        const ctx = this.ctx;
        const img = this.img;
        const d = img.data;

        // animate very slightly (gives "live" crt feel, not static)
        this.t += 1;

        // --- 1) low-res grain with tiny chroma separation ---
        // We do grayscale + small per-channel offset to mimic CRT phosphor noise.
        // Keep it subtle so it doesn't look like RGB glitter.
        for(let i=0;i<d.length;i+=4){
          const v = (Math.random()*256)|0;

          // mild chroma wobble
          const cr = ((Math.random()*18)|0) - 9;
          const cg = ((Math.random()*18)|0) - 9;
          const cb = ((Math.random()*18)|0) - 9;

          d[i]   = this._clampByte(v + cr);
          d[i+1] = this._clampByte(v + cg);
          d[i+2] = this._clampByte(v + cb);

          // alpha: not tiny. Your old "5" was effectively invisible.
          // Also add a very small breathing to feel analog.
          const a = this.baseAlpha + (((Math.sin((this.t + i*0.0007)*0.06) * 10) | 0));
          d[i+3] = this._clampByte(a);
        }

        ctx.putImageData(img, 0, 0);

        // --- 2) scanlines/glitches: rare and soft ---
        // bright line
        if (Math.random() < this.lineProbBright){
          const y = (Math.random()*this.h)|0;
          ctx.fillStyle = "rgba(255,255,255,.14)";
          ctx.fillRect(0, y, this.w, 1);
        }

        // dark line
        if (Math.random() < this.lineProbDark){
          const y = (Math.random()*this.h)|0;
          ctx.fillStyle = "rgba(0,0,0,.14)";
          ctx.fillRect(0, y, this.w, 2);
        }

        // occasional burst (2-4 near lines)
        if (Math.random() < this.lineBurstProb){
          const baseY = (Math.random()*this.h)|0;
          const n = 2 + ((Math.random()*3)|0);
          ctx.fillStyle = "rgba(255,255,255,.10)";
          for(let k=0;k<n;k++){
            const y = baseY + k;
            if (y>=0 && y<this.h) ctx.fillRect(0, y, this.w, 1);
          }
        }

        this._raf = requestAnimationFrame(()=>this.loop());
      }
    }
    const pix = new PixelOverlay($("pix"));

    /* =========================================================
   Step 1: courier (REPLACE v2)
   ========================================================= */
    const signModal = $("signModal");
    const courierBubble = $("courierBubble");
    const courierText = $("courierText");
    const courierWho = $("courierWho");

    const actionTitle = $("actionTitle");
    const actionSub = $("actionSub");

    let btnNo = $("btnNo");
    let btnYes = $("btnYes");

    /* ----- tiny sound design (no new assets) ----- */
    function sfxKnock(){
      if (!audio?.unlocked) return;

      // –¥–≤–∞ –∫–æ—Ä–æ—Ç–∫–∏—Ö "—Ç—É–∫"
      audio._beep(0.09, 130, 0.06, 2);
      setTimeout(()=>audio._beep(0.08, 110, 0.07, 2), 120);
    }
    function sfxPositive(){
      // pleasant short two-tone
      if (audio && audio._beep) {
        audio._beep(0.06, 720, 0.07, 0);
        audio._beep(0.05, 980, 0.08, 1);
      } else {
        audio.sfx("success");
      }
    }
    function sfxNegative(){
      // harsh down tone
      if (audio && audio._beep) {
        audio._beep(0.06, 180, 0.10, 2);
        audio._beep(0.05, 140, 0.10, 2);
      } else {
        audio.sfx("wrong");
      }
    }

    function shakeTop(){
      courierBubble.classList.add("shake");
      setTimeout(()=>courierBubble.classList.remove("shake"), 380);
    }
    function shakeScreen(){
      // reuse shake class on viewport (exists visually due to transform)
      const v = $("viewport");
      if (!v) return;
      v.classList.add("shake");
      setTimeout(()=>v.classList.remove("shake"), 380);
    }

    function setTop(who, text){
      if (courierWho) courierWho.textContent = who;
      if (courierText) courierText.textContent = text;
    }

    function setCenter(title, sub, yesLabel="–î–∞", noLabel="–ù–µ—Ç", showNo=true){
      actionTitle.textContent = title;
      actionSub.textContent = sub;

      // recreate buttons cleanly (so we can swap labels/visibility without CSS edits)
      const wrap = $("actionButtons");
      wrap.innerHTML = "";

      if (showNo){
        const bNo = document.createElement("button");
        bNo.className = "btn ghost wide";
        bNo.id = "btnNo";
        bNo.textContent = noLabel;
        wrap.appendChild(bNo);
        btnNo = bNo;
      } else {
        btnNo = null;
      }

      const bYes = document.createElement("button");
      bYes.className = "btn primary wide";
      bYes.id = "btnYes";
      bYes.textContent = yesLabel;
      wrap.appendChild(bYes);
      btnYes = bYes;
    }

    /* ----- dialogue state machine ----- */
    const STEP = {
      DOOR_ASK_1: 0,
      DOOR_ASK_2: 1,
      JAMA_ASK: 2,
      SIGN_FROM_NO: 3,
      SIGN_FROM_YES: 4,
      PICKUP_FROM_SIGN_YES: 5,
      PICKUP_FROM_SIGN_NO: 6
    };
    let st = STEP.DOOR_ASK_1;

    function render(){
      if (st === STEP.DOOR_ASK_1){
        setTop("–°–Ω–∞—Ä—É–∂–∏", "*–¢—É–∫ —Ç—É–∫*");
        setCenter("–û—Ç–∫—Ä—ã—Ç—å –¥–≤–µ—Ä—å?", "–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ", "–î–∞", "–ù–µ—Ç", true);
        sfxKnock();
        shakeTop();

        btnNo.addEventListener("click", ()=>{
          sfxNegative();
          shakeScreen();
          st = STEP.DOOR_ASK_2;
          render();
        }, {once:true});

        btnYes.addEventListener("click", ()=>{
          sfxPositive();
          st = STEP.JAMA_ASK;
          render();
        }, {once:true});
      }

      else if (st === STEP.DOOR_ASK_2){
        setTop("–°–Ω–∞—Ä—É–∂–∏", "–û–π –Ω–µ –¥–µ–ª–∞–π—Ç–µ –≤–∏–¥ —á—Ç–æ –Ω–∏–∫–æ–≥–æ –Ω–µ—Ç—É, –Ω–µ –±—É–¥—å—Ç–µ –±–∞–ª–±–µ—Å–∞–º–∏ –±–æ–∂–µ–µ–µ‚Ä¶ *–ü–æ–≤—Ç–æ—Ä–Ω—ã–π —Å—Ç—É–∫*");
        setCenter("–û—Ç–∫—Ä—ã—Ç—å –¥–≤–µ—Ä—å?", "–ù—É –¥–∞–≤–∞–π üôÇ", "–î–∞", "", false);
        sfxKnock(); // –ø–æ–≤—Ç–æ—Ä–Ω—ã–π —Å—Ç—É–∫
        shakeTop();

        btnYes.addEventListener("click", ()=>{
          sfxPositive();
          st = STEP.JAMA_ASK;
          render();
        }, {once:true});
      }

      else if (st === STEP.JAMA_ASK){
        setTop("–Ø–Ω–¥–µ–∫—Å-–ö—É—Ä—å–µ—Ä", "–•–æ–ª–∞, –≤–∞—Å –∑–æ–≤—É—Ç –ü—É–ø—Å–∏–∫, –≤–µ—Ä–Ω–æ?");
        setCenter("–°–æ–≥–ª–∞—Å–∏—Ç—å—Å—è?", "–í—ã–±–µ—Ä–∏—Ç–µ –æ—Ç–≤–µ—Ç", "–î–∞", "–ù–µ—Ç", true);

        btnNo.addEventListener("click", ()=>{
          sfxNegative();
          shakeScreen();
          st = STEP.SIGN_FROM_NO;
          render();
        }, {once:true});

        btnYes.addEventListener("click", ()=>{
          sfxPositive();
          st = STEP.SIGN_FROM_YES;
          render();
        }, {once:true});
      }

      else if (st === STEP.SIGN_FROM_NO){
        setTop(
          "–Ø–Ω–¥–µ–∫—Å-–ö—É—Ä—å–µ—Ä",
          "–î–∞ –Ω–µ –ø–∏–∑–¥–∏—Ç–µ, –ø–æ –∫—Ä–∞—Å–∏–≤—ã–º —Ñ–∞—Ä–∞–º –≤–∏–∂—É —á—Ç–æ —ç—Ç–æ –≤—ã! –Ø –∂–µ –Ω–µ –ø–æ–¥–∫–∞—Ç—ã–≤–∞—é, —Ç–∞–∫ —á—Ç–æ —É—Å–ø–æ–∫–æ–π—Ç–µ—Å—å, —è –ø—Ä–æ—Å—Ç–æ –ø—Ä–∏–Ω—ë—Å –ø–æ—Å—ã–ª–∫—É –æ—Ç –≤–∞—à–µ–≥–æ —Ñ–∞–Ω–∞—Ç–∞! –í–∞–º –æ—Å—Ç–∞–ª–æ—Å—å —Ç–æ–ª—å–∫–æ —Ä–∞—Å–ø–∏—Å–∞—Ç—å—Å—è –∑–∞ –ø–æ–ª—É—á–µ–Ω–∏–µ –∏ –∑–∞–±—Ä–∞—Ç—å –≤–∞—à —á—ë—Ç–∫–∏–π –ø–æ–¥–∞—Ä–æ–∫ :)"
        );
        setCenter("–†–∞—Å–ø–∏—Å–∞—Ç—å—Å—è?", "–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –ø–æ–ª—É—á–µ–Ω–∏–µ", "–î–∞", "–ù–µ—Ç", true);

        btnYes.addEventListener("click", ()=>{
          sfxPositive();
          st = STEP.PICKUP_FROM_SIGN_YES;
          render();
        }, {once:true});

        btnNo.addEventListener("click", ()=>{
          sfxNegative();
          shakeTop();
          st = STEP.PICKUP_FROM_SIGN_NO;
          render();
        }, {once:true});
      }

      else if (st === STEP.SIGN_FROM_YES){
        setTop(
          "–Ø–Ω–¥–µ–∫—Å-–ö—É—Ä—å–µ—Ä",
          "–Ø —Å —Ö–æ—Ä–æ—à–∏–º–∏ –Ω–æ–≤–æ—Å—Ç—è–º–∏, –æ–¥–∏–Ω –æ—á–µ–Ω—å –∫—Ä–∞—Å–∏–≤—ã–π –∏ —Å–µ–∫—Å—É–∞–ª—å–Ω—ã–π —Ñ–∞–Ω–∞—Ç –≤–∞–º –æ—Ç–ø—Ä–∞–≤–∏–ª –ø–æ—Å—ã–ª–∫—É, —Ä–∞—Å–ø–∏—à–∏—Ç–µ—Å—å –∏ –º–æ–∂–µ—Ç–µ –Ω–∞—Å–ª–∞–¥–∏—Ç—å—Å—è —Å–≤–æ–∏–º –µ–±–µ–π—à–∏–º, –∫–∞–∫ –∏ –≤—ã, –ø–æ–¥–∞—Ä–∫–æ–º :)"
        );
        setCenter("–†–∞—Å–ø–∏—Å–∞—Ç—å—Å—è?", "–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –ø–æ–ª—É—á–µ–Ω–∏–µ", "–î–∞", "–ù–µ—Ç", true);

        btnYes.addEventListener("click", ()=>{
          sfxPositive();
          st = STEP.PICKUP_FROM_SIGN_YES;
          render();
        }, {once:true});

        btnNo.addEventListener("click", ()=>{
          sfxNegative();
          shakeTop();
          st = STEP.PICKUP_FROM_SIGN_NO;
          render();
        }, {once:true});
      }

      else if (st === STEP.PICKUP_FROM_SIGN_YES){
        setTop("–Ø–Ω–¥–µ–∫—Å-–ö—É—Ä—å–µ—Ä", "–£–£–£ —Ç–∞–∫ –≤—ã –¥—É—à–Ω–∏–ª–∞ –∫–æ—Ç–æ—Ä–∞—è –ø—Ä–∞–≤–∏–ª–∞ —Å–æ–±–ª—é–¥–∞–µ—Ç–µ, —Ç–∞–∫, –≤—Å–µ–µ–µ! –í–æ—Ç –≤–∞—à–∞ –ø–æ—Å—ã–ª–∫–∞ :)");
        setCenter("–ó–∞–±—Ä–∞—Ç—å –ø–æ—Å—ã–ª–∫—É?", "–ò –ø–µ—Ä–µ–π—Ç–∏ –∫ –ø–æ–¥–∞—Ä–∫—É", "–î–∞", "", false);

        btnYes.addEventListener("click", ()=>{
          sfxPositive();
          audio.sfx("paper");
          showStep(1); // <-- —Ç–æ–ª—å–∫–æ —Ç—É—Ç –ø–µ—Ä–µ—Ö–æ–¥–∏–º –∫ –∫–æ—Ä–æ–±–∫–µ
        }, {once:true});
      }

      else if (st === STEP.PICKUP_FROM_SIGN_NO){
        setTop("–Ø–Ω–¥–µ–∫—Å-–ö—É—Ä—å–µ—Ä", "–ü—Ñ—Ñ, –º–Ω–µ –ª–µ–Ω—å —Ä–∞–∑–±–∏—Ä–∞—Ç—å—Å—è —Å –≤–∞–º–∏, –ø–æ—ç—Ç–æ–º—É –ø—Ä–æ—Å—Ç–æ –∑–∞–±–∏—Ä–∞–π—Ç–µ –ø–æ—Å—ã–ª–∫—É... –±–µ –±–µ –±–µ");
        setCenter("–ó–∞–±—Ä–∞—Ç—å –ø–æ—Å—ã–ª–∫—É?", "–ò –ø–µ—Ä–µ–π—Ç–∏ –∫ –ø–æ–¥–∞—Ä–∫—É", "–î–∞", "", false);

        btnYes.addEventListener("click", ()=>{
          sfxPositive();
          audio.sfx("paper");
          showStep(1); // <-- —Ç–æ–ª—å–∫–æ —Ç—É—Ç –ø–µ—Ä–µ—Ö–æ–¥–∏–º –∫ –∫–æ—Ä–æ–±–∫–µ
        }, {once:true});
      }
    }

    /* init state */
    render();

    /* =========================================================
       Step 2: box + lock + open + envelope arc
       ========================================================= */
    const boxObj=$("boxObj");
    const lockBtn=$("lockBtn");
    const lockModal=$("lockModal");
    const lockBack=$("lockBack");
    const lockDone=$("lockDone");
    const boxReset=$("boxReset");
    const box3d=$("box3d");

    const envPullReal = $("envPullReal");

    const boxRot = new InertialRotator(boxObj, {rotX: 14, rotY: -22});
    boxReset.addEventListener("click", ()=>{ audio.sfx("click"); boxRot.reset(); });

    function openLock(){
      audio.sfx("lock");
      lockModal.classList.add("show");
    }
    function closeLockUI(){
      audio.sfx("paper");
      lockModal.classList.remove("show");
    }

    let lockDown = null;
    lockBtn.addEventListener("pointerdown", (e)=>{
      lockDown = {x:e.clientX, y:e.clientY, t: now()};
      e.stopPropagation();
    }, {passive:true});

    lockBtn.addEventListener("pointerup", (e)=>{
      if(!lockDown) return;
      const dx=Math.abs(e.clientX-lockDown.x);
      const dy=Math.abs(e.clientY-lockDown.y);
      const dt=now()-lockDown.t;
      lockDown=null;
      if(dx<8 && dy<8 && dt<600) openLock();
      e.stopPropagation();
    }, {passive:true});

    lockBack.addEventListener("click", ()=> closeLockUI());

    const days = Array.from({length:31}, (_,i)=>i+1);
    const months = ["–Ø–Ω–≤–∞—Ä—å","–§–µ–≤—Ä–∞–ª—å","–ú–∞—Ä—Ç","–ê–ø—Ä–µ–ª—å","–ú–∞–π","–ò—é–Ω—å","–ò—é–ª—å","–ê–≤–≥—É—Å—Ç","–°–µ–Ω—Ç—è–±—Ä—å","–û–∫—Ç—è–±—Ä—å","–ù–æ—è–±—Ä—å","–î–µ–∫–∞–±—Ä—å"];
    const years = [2020,2021,2022,2023,2024,2025,2026];

    const reelDay = new Reel($("reels").querySelector('[data-reel="day"]'), $("reelDay"), days, v=>String(v));
    const reelMonth = new Reel($("reels").querySelector('[data-reel="month"]'), $("reelMonth"), months, v=>v);
    const reelYear = new Reel($("reels").querySelector('[data-reel="year"]'), $("reelYear"), years, v=>String(v));

    reelDay.setIndex(0,true);
    reelMonth.setIndex(0,true);
    reelYear.setIndex(0,true);

    function lockShake(modalEl){
      audio.sfx("wrong");
      const m = modalEl.querySelector(".modal");
      m.classList.add("shake");
      setTimeout(()=>m.classList.remove("shake"), 380);
    }

    async function unlockSequence(){
      audio.sfx("success");
      audio.sfx("sparkle");

      // ‚úÖ —á–∞—Å—Ç–∏—Ü—ã –∏–∑ –∫—Ä—ã—à–∫–∏ –∫–æ—Ä–æ–±–∫–∏
      const topRect = $("boxTop").getBoundingClientRect();
      const vpRect  = $("viewport").getBoundingClientRect();

      const x = (topRect.left + topRect.width/2) - vpRect.left;
      const y = (topRect.top  + topRect.height/2) - vpRect.top;

      fx.burstAt(x, y, "confetti", 1.15);
      setTimeout(()=>fx.burstAt(x, y-18, "hearts", 1.00), 70);
      audio.sfx("success");
      fx.burst("confetti");
      audio.sfx("sparkle");

      lockBtn.classList.remove("pulse");
      lockBtn.style.opacity = "0";
      lockBtn.style.transform = "translate(-50%,-50%) scale(.90)";

      closeLockUI();

      // 1) open lid
      box3d.classList.add("opened");
      audio.sfx("whoosh");

      // 2) envelope flies out on arc
      setTimeout(()=>{
        envPullReal.classList.add("fly");
        audio.sfx("paper");
        fx.burst("hearts");
      }, 520);

      // 3) proceed to envelope step
      setTimeout(()=> showStep(2), 1520);
    }

    lockDone.addEventListener("click", ()=>{
      audio.sfx("click");
      const day = reelDay.getValue();
      const month = reelMonth.getValue();
      const year = reelYear.getValue();
      const ok = (day===CONFIG.boxLock.day && months.indexOf(month)===CONFIG.boxLock.monthIndex && year===CONFIG.boxLock.year);
      if(!ok){ lockShake(lockModal); return; }
      unlockSequence();
    });

    /* =========================================================
       Step 3: envelope DOB-lock on seal + letter slides out
       ========================================================= */
    const envObj=$("envObj");
    const envRot = new InertialRotator(envObj, {rotX: 12, rotY: 18});

    const sealBtn=$("sealBtn");
    const env3d=$("env3d");
    const envHint=$("envHint");

    const throwBtn=$("throwBtn");
    const centerMsg=$("centerMsg");
    const centerMsgBox=$("centerMsgBox");

    const envLockModal=$("envLockModal");
    const envLockBack=$("envLockBack");
    const envLockDone=$("envLockDone");

    const letterSlide=$("letterSlide");
    const restart=$("restart");

    const envReelDay = new Reel($("envReels").querySelector('[data-reel="day"]'), $("envReelDay"), days, v=>String(v));
    const envReelMonth = new Reel($("envReels").querySelector('[data-reel="month"]'), $("envReelMonth"), months, v=>v);
    const envReelYear = new Reel($("envReels").querySelector('[data-reel="year"]'), $("envReelYear"), [2000,2001,2002,2003,2004,2005,2006,2007], v=>String(v));

    envReelDay.setIndex(0,true);
    envReelMonth.setIndex(0,true);
    envReelYear.setIndex(0,true);

    let envUnlocked = false;
    let envelopeOpened = false;

    function showCenterText(text){
      centerMsgBox.textContent = text;
      centerMsg.classList.add("show");
      setTimeout(()=>centerMsg.classList.remove("show"), 1200);
    }

    function openEnvLock(){
      audio.sfx("lock");
      envLockModal.classList.add("show");
    }
    function closeEnvLock(){
      audio.sfx("paper");
      envLockModal.classList.remove("show");
    }

    envLockBack.addEventListener("click", ()=> closeEnvLock());

    envLockDone.addEventListener("click", ()=>{
      audio.sfx("click");
      const day = envReelDay.getValue();
      const month = envReelMonth.getValue();
      const year = envReelYear.getValue();
      const ok = (day===CONFIG.envLock.day && months.indexOf(month)===CONFIG.envLock.monthIndex && year===CONFIG.envLock.year);
      if(!ok){ lockShake(envLockModal); return; }

      envUnlocked = true;
      closeEnvLock();

      // —Ç–æ–ª—å–∫–æ –∑–≤—É–∫ —É—Å–ø–µ—Ö–∞, –±–µ–∑ —á–∞—Å—Ç–∏—Ü
      audio.sfx("success");

      envHint.textContent = "–°–º–æ—Ç—Ä–∏ –∏ –Ω–∞—Å–ª–∞–∂–¥–∞–π—Å—è :)";
      sealBtn.classList.remove("pulse");
      sealBtn.classList.add("pulse");
    });

    function openEnvelopeAndLetter(){
      if (envelopeOpened) return;
      envelopeOpened = true;

      audio.sfx("whoosh");
      sealBtn.classList.add("wiggle");
      setTimeout(()=>sealBtn.classList.remove("wiggle"), 380);

      env3d.classList.add("opened");

      // –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –ø–µ—á–∞—Ç–∏
      const sealRect = sealBtn.getBoundingClientRect();
      const vpRect = $("viewport").getBoundingClientRect();
      const x = (sealRect.left + sealRect.width/2) - vpRect.left;
      const y = (sealRect.top  + sealRect.height/2) - vpRect.top;

      // ===== –ú–û–ú–ï–ù–¢ –¢–ò–®–ò–ù–´ (–ø—Ä–æ—Å—Ç–∞—è –≤–µ—Ä—Å–∏—è) =====
      const prevVol = (audio.bgmBus ? audio.bgmBus.gain.value : audio.bgmGain);

      // –º—É–∑—ã–∫–∞ –ø–æ—á—Ç–∏ –≤ 0
      if (audio.bgmBus) audio.bgmBus.gain.value = 0.002;
      else if (audio.bgmEl) audio.bgmEl.volume = 0.002;

      // —Å—Ç–æ–ø —á–∞—Å—Ç–∏—Ü—ã
      fx.particles.length = 0;
      if (fx._raf){ cancelAnimationFrame(fx._raf); fx._raf = null; }
      fx.ctx.clearRect(0,0,fx.w,fx.h);

      // –ø–∞—É–∑–∞ 0.5 —Å–µ–∫
      setTimeout(()=>{

        // –≤–µ—Ä–Ω—É—Ç—å –≥—Ä–æ–º–∫–æ—Å—Ç—å
        if (audio.bgmBus) audio.bgmBus.gain.value = prevVol;
        else if (audio.bgmEl) audio.bgmEl.volume = prevVol;

        // –≤–∑—Ä—ã–≤ –ª—é–±–≤–∏
        audio.sfx("sparkle");
        fx.timeScale = 0.32;
        setTimeout(()=>fx.timeScale = 1, 520);

        fx.burstAt(x, y, "hearts", 1.45);
        setTimeout(()=>fx.burstAt(x, y, "confetti", 1.35), 70);
        setTimeout(()=>fx.burstAt(x, y - 14, "hearts", 1.25), 140);

        // –ø–∏—Å—å–º–æ –≤—ã–µ–∑–∂–∞–µ—Ç
        setTimeout(()=>{
          audio.sfx("paper");
          letterSlide.classList.add("show");
        }, 420);

      }, 500);
    }

    // Seal behavior: first it opens lock, after unlock it opens envelope
    let sealDown = null;
    sealBtn.addEventListener("pointerdown", (e)=>{
      sealDown = {x:e.clientX, y:e.clientY, t: now()};
      e.stopPropagation();
    }, {passive:true});

    sealBtn.addEventListener("pointerup", (e)=>{
      if(!sealDown) return;
      const dx=Math.abs(e.clientX-sealDown.x);
      const dy=Math.abs(e.clientY-sealDown.y);
      const dt=now()-sealDown.t;
      sealDown=null;
      if(dx>=10 || dy>=10 || dt>650) return;

      if (!envUnlocked){
        openEnvLock();
      } else {
        openEnvelopeAndLetter();
      }
      e.stopPropagation();
    }, {passive:true});

    // Only "throw away" button
    let throwUsed=false;
    const envWrap = $("envWrap");

    throwBtn.addEventListener("click", ()=>{
      audio.sfx("wrong");

      // –Ω–∞–¥–ø–∏—Å—å –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è 600–º—Å
      showCenterText("–¢—ã —á—Ç–æ –≤–æ–æ–±—â–µ –∞—à–∞–ª–µ–ª–∞. –Ø —Ç—É—Ç —Å –¥—É—à–æ–π, –∞ —Ç—ã... –î–∞–≤–∞–π –Ω–µ –≤—ã–ø–µ–Ω–¥—Ä–∏–≤–∞–π—Å—è üôÑ");
      envWrap.classList.add("shake");
      setTimeout(()=>envWrap.classList.remove("shake"), 600);

      if (!throwUsed){
        throwUsed=true;

        // –ñ–î–Å–ú 600–º—Å, –ø–æ—Ç–æ–º –∫–æ–Ω–≤–µ—Ä—Ç –ø–∞–¥–∞–µ—Ç –≤–Ω–∏–∑
        setTimeout(()=>{
          audio.sfx("whoosh");
          envWrap.classList.add("drop");   // <- –≤–æ—Ç —ç—Ç–æ "–æ–ø—É—Å—Ç–∏—Ç—å –∫–æ–Ω–≤–µ—Ä—Ç"

          throwBtn.classList.add("hidden"); // –∫–Ω–æ–ø–∫—É —É–±—Ä–∞—Ç—å
          // remove –º–æ–∂–µ—à—å –≤–æ–æ–±—â–µ –Ω–µ –¥–µ–ª–∞—Ç—å (—á—Ç–æ–±—ã –Ω–µ –ø—Ä—ã–≥–∞–ª–æ)
        }, 600);
      }
    });

    restart.addEventListener("click", ()=>{
      audio.sfx("sparkle"); // –∑–≤—É–∫

      // –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã —Ü–µ–Ω—Ç—Ä–∞ –∫–Ω–æ–ø–∫–∏ (–Ω–∞–¥—ë–∂–Ω–µ–µ —á–µ–º letterSlide)
      const vpRect = $("viewport").getBoundingClientRect();
      const b = restart.getBoundingClientRect();
      const x = (b.left + b.width/2) - vpRect.left;
      const y = (b.top + b.height/2) - vpRect.top;

      fx.timeScale = 0.6;
      setTimeout(()=>fx.timeScale = 1, 650);

      fx.burstAt(x, y, "hearts", 1.35);
      setTimeout(()=>fx.burstAt(x-40, y, "hearts", 1.10), 120);
      setTimeout(()=>fx.burstAt(x+40, y, "hearts", 1.10), 240);
      setTimeout(()=>fx.burstAt(x, y-25, "hearts", 1.20), 360);

      // –ª—ë–≥–∫–∞—è –¥—Ä–æ–∂—å –ø–∏—Å—å–º–∞
      letterSlide.classList.add("shake");
      setTimeout(()=>letterSlide.classList.remove("shake"), 380);
    });
    /* =========================================================
       Cinematic breathing + emotion sync (box/env pulse)
       ========================================================= */
    const Pulse = (() => {
      // –±–∞–∑–æ–≤—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã "–¥—ã—Ö–∞–Ω–∏—è"
      let baseAmp   = 0.025;  // –±–∞–∑–æ–≤–∞—è –∞–º–ø–ª–∏—Ç—É–¥–∞
      let baseSpeed = 0.55;   // –±–∞–∑–æ–≤–∞—è —Å–∫–æ—Ä–æ—Å—Ç—å (—Ü–∏–∫–ª—ã/—Å–µ–∫)

      // —É—Å–∏–ª–µ–Ω–∏–µ (—ç–º–æ—Ü–∏–∏)
      let boost = 0;          // 0..1
      let boostTarget = 0;    // –∫—É–¥–∞ —Å—Ç—Ä–µ–º–∏–º—Å—è
      let boostDecay = 1.2;   // –∫–∞–∫ –±—ã—Å—Ç—Ä–æ –∑–∞—Ç—É—Ö–∞–µ—Ç
      let boostRise  = 7.0;   // –∫–∞–∫ –±—ã—Å—Ç—Ä–æ –Ω–∞–±–∏—Ä–∞–µ—Ç—Å—è

      let t0 = performance.now();

      function bgmIsPlaying(){
        return !!(audio && audio.bgmEl && !audio.bgmEl.paused);
      }

      // –º—è–≥–∫–∏–π "–∫–∏–Ω–æ—à–Ω—ã–π" –∏–º–ø—É–ª—å—Å: –≤–¥–æ—Ö/–≤—ã–¥–æ—Ö, –±–µ–∑ –¥—Ä–æ–∂–∏
      function shapeWave(t, speed){
        // –æ—Å–Ω–æ–≤–Ω–æ–π –≤–¥–æ—Ö
        const a = Math.sin(t * speed * Math.PI * 2);
        const b = Math.sin(t * speed * Math.PI * 4) * 0.22; // –ª–µ–≥–∫–∞—è "–Ω–µ—Ä–æ–≤–Ω–æ—Å—Ç—å"
        const x = (a * 0.70 + b * 0.30); // -1..1
        const y = (x * 0.5 + 0.5);      // 0..1

        // –¥–µ–ª–∞–µ–º "—É–¥–∞—Ä" —á—É—Ç—å –±–æ–ª–µ–µ –≤—ã—Ä–∞–∂–µ–Ω–Ω—ã–º, –Ω–æ –º—è–≥–∫–∏–º
        return Math.pow(y, 1.9);
      }

      // –≤—ã–∑–æ–≤: Pulse.hit({strength, hold, decay, speedUp})
      function hit(opts={}){
        const strength = Math.max(0, Math.min(1, opts.strength ?? 0.6));
        const holdMs   = opts.hold ?? 0;
        boostDecay     = opts.decay ?? 1.2;

        // —Å—Ä–∞–∑—É –ø–æ–¥–Ω–∏–º–µ–º —Ç–∞—Ä–≥–µ—Ç
        boostTarget = Math.max(boostTarget, strength);

        // –µ—Å–ª–∏ –Ω–∞–¥–æ –ø–æ–¥–µ—Ä–∂–∞—Ç—å ‚Äî –¥–µ—Ä–∂–∏–º —Ç–∞—Ä–≥–µ—Ç –∏ –ø–æ—Ç–æ–º –æ—Ç–ø—É—Å–∫–∞–µ–º
        if (holdMs > 0){
          setTimeout(()=>{ boostTarget = 0; }, holdMs);
        } else {
          // –Ω–µ–±–æ–ª—å—à–æ–π –∞–≤—Ç–æ—Å–ø–∞–¥ —á—Ç–æ–±—ã –Ω–µ –∑–∞–ª–∏–ø–∞–ª–æ
          setTimeout(()=>{ boostTarget = 0; }, 180);
        }

        // –∫—Ä–∞—Ç–∫–æ–≤—Ä–µ–º–µ–Ω–Ω–æ–µ —É—Å–∫–æ—Ä–µ–Ω–∏–µ –º–æ–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å —á–µ—Ä–µ–∑ –≤—Ä–µ–º–µ–Ω–Ω—É—é —Å–º–µ–Ω—É baseSpeed
        if (opts.speedUp){
          const old = baseSpeed;
          baseSpeed = Math.max(0.35, Math.min(1.2, old + opts.speedUp));
          setTimeout(()=>{ baseSpeed = old; }, opts.speedUpHold ?? 520);
        }
      }

      function tick(){
        const t = (performance.now() - t0) / 1000;

        // –ø–ª–∞–≤–Ω–æ —Ç—è–Ω–µ–º boost –∫ boostTarget
        const dt = 1/60;
        const riseK  = boostRise;
        const decayK = boostDecay;

        if (boost < boostTarget){
          boost += (boostTarget - boost) * (1 - Math.exp(-riseK * dt));
        } else {
          boost += (boostTarget - boost) * (1 - Math.exp(-decayK * dt));
        }

        // –∞–º–ø–ª–∏—Ç—É–¥–∞ –∏ —Å–∫–æ—Ä–æ—Å—Ç—å –∑–∞–≤–∏—Å—è—Ç –æ—Ç boost
        const amp   = baseAmp + boost * 0.020;      // +2% max
        const speed = baseSpeed + boost * 0.55;     // —É—Å–∫–æ—Ä–µ–Ω–∏–µ –≤ —ç–º–æ—Ü–∏—è—Ö

        const w = shapeWave(t, speed);

        if (bgmIsPlaying()){
          // Step2: box
          if (boxRot){
            const extra = (stepIndex === 1 ? 0.006 : 0.0);
            boxRot.setScale(1 + (w * (amp + extra)));
          }

          // Step3: env
          if (envRot){
            const extra = (stepIndex === 2 ? 0.006 : 0.0);
            envRot.setScale(1 + (w * (amp + extra)));
          }
        } else {
          boxRot?.setScale(1);
          envRot?.setScale(1);
        }

        requestAnimationFrame(tick);
      }

      requestAnimationFrame(tick);

      return { hit };
    })();

    /* =========================================================
       Easter egg: box talks every 15 taps (shuffle-bag random)
       ========================================================= */
    (() => {
      const lines = [
        // —Ç–≤–æ–∏
        "–æ–π –Ω—É —Ö–≤–∞—Ç–∏—Ç –º–µ–Ω—è –ª–∞–ø–∞—Ç—å, –æ—Ç–∫—Ä—ã–≤–∞–π —É–∂–µ",
        "–ù–µ –Ω–∞–¥–æ–µ–ª–æ –≤–µ—Ä—Ç–µ—Ç—å –∏ —Ç—ã–∫–∞—Ç—å –º–µ–Ω—è?",
        "–û–π –ø—Ä–∏–≤–µ—Ç, –∫–∞–∫ –¥–µ–ª–∞ :p",
        "–£ —Ç–µ–±—è –∫—Ä–∞—Å–∏–≤—ã–µ –≥–ª–∞–∑–∞, –∫–∞–∫ –Ω–∞ —Å—á–µ—Ç —Ç–æ–≥–æ —á—Ç–æ–±—ã –Ω–∏—á–µ–≥–æ –Ω–µ—Ç—Ä–æ–≥–∞—Ç—å –∏ –ø—Ä–æ—Å—Ç–æ —Å–º–æ—Ç—Ä–µ—Ç—å",
        "–≠–π, —è –≤–æ–æ–±—â–µ-—Ç–æ –∫–æ—Ä–æ–±–∫–∞, –∞ –Ω–µ –∏–≥—Ä—É—à–∫–∞",
        "–¢—ã –º–µ–Ω—è —É–∂–µ –∑–∞–∫—Ä—É—Ç–∏–ª–∞",
        "–û—Ç–∫—Ä—ã–≤–∞–π —É–∂–µ, –≤–Ω—É—Ç—Ä–∏ –∏–Ω—Ç–µ—Ä–µ—Å–Ω–µ–µ",
        "–ú–Ω–µ —â–µ–∫–æ—Ç–Ω–æ üò≥",
        "–ï—â—ë —á—É—Ç—å-—á—É—Ç—å –∏ —è –Ω–∞—á–Ω—É –º—è—É–∫–∞—Ç—å",
        "–Ø —Ç–µ—Ä–ø–ª—é‚Ä¶ –Ω–æ –Ω–µ –±–µ—Å–∫–æ–Ω–µ—á–Ω–æ",
        "–ú–æ–∂–µ—Ç —É–∂–µ –∑–∞–º–æ–∫ –Ω–∞–∂–º—ë—à—å, –∞?",
        "–û–π –≤—Å—ë, —è –æ–±–∏–¥–µ–ª–∞—Å—å",

        // –Ω–æ–≤—ã–µ (–µ—â—ë –º–Ω–æ–≥–æ)
        "–ê–ª–ª–æ, —è —Ç—É—Ç. –û–¢–ö–†–´–í–ê–ô.",
        "–Ø —á—É–≤—Å—Ç–≤—É—é —Å–µ–±—è —Å–ø–∏–Ω–Ω–µ—Ä–æ–º –∏–∑ 2017",
        "–ï—Å–ª–∏ —ç—Ç–æ —Ñ–ª–∏—Ä—Ç ‚Äî —Ç–æ —è —Å–º—É—â–∞—é—Å—å",
        "–°–ª—É—à–∞–π‚Ä¶ –∞ —Ç—ã –≤—Å–µ–≥–¥–∞ —Ç–∞–∫–∞—è –Ω–∞—Å—Ç–æ–π—á–∏–≤–∞—è?",
        "–Ø –±—ã –ø–æ–∫—Ä–∞—Å–Ω–µ–ª–∞, –Ω–æ —è –∫–∞—Ä—Ç–æ–Ω–Ω–∞—è",
        "–ú–º–º‚Ä¶ –æ—Å—Ç–æ—Ä–æ–∂–Ω–æ, —è —Ö—Ä—É–ø–∫–∞—è —Å–Ω–∞—Ä—É–∂–∏ –∏ –Ω–µ–∂–Ω–∞—è –≤–Ω—É—Ç—Ä–∏",
        "–í–Ω—É—Ç—Ä–∏ —Å—é—Ä–ø—Ä–∏–∑, —Å–Ω–∞—Ä—É–∂–∏ —Ç—ã",
        "–ï—â—ë 1 —Ä–∞–∑ ‚Äî –∏ —è —Å–∞–º–∞ –æ—Ç–∫—Ä–æ—é—Å—å‚Ä¶ (–Ω–µ—Ç)",
        "–¢—ã —É–≤–µ—Ä–µ–Ω–∞, —á—Ç–æ –Ω–µ —Ö–æ—á–µ—à—å –Ω–∞–∂–∞—Ç—å –Ω–∞ –∑–∞–º–æ–∫?",
        "–û–∫–µ–π, –∏–≥—Ä–∞–π—Å—è. –ù–æ –ø–æ—Ç–æ–º –æ—Ç–∫—Ä—ã–≤–∞–π!",
        "–ú–Ω–µ –Ω—Ä–∞–≤–∏—Ç—Å—è –≤–Ω–∏–º–∞–Ω–∏–µ, –Ω–æ –º–æ–∂–Ω–æ –ø–æ –¥–µ–ª—É?",
        "–ï—Å–ª–∏ —Ç–µ–±–µ —Å–∫—É—á–Ω–æ ‚Äî —É –º–µ–Ω—è –µ—Å—Ç—å –∑–∞–º–æ–∫ ü§®",
        "–Ø —Ç—É—Ç –≤–æ–æ–±—â–µ-—Ç–æ –¥–ª—è –ø–æ–¥–∞—Ä–∫–∞, –∞ –Ω–µ –¥–ª—è –º–∞—Å—Å–∞–∂–∞",
        "–¢—ã —Ç–∞–∫–∞—è —É–ø–æ—Ä–Ω–∞—è‚Ä¶ —ç—Ç–æ –º–∏–ª–æ",
        "–Ø —É–∂–µ —É—Å—Ç–∞–ª–∞ –ø—Ä–∏—Ç–≤–æ—Ä—è—Ç—å—Å—è —Å—Ç—Ä–æ–≥–æ–π –∫–æ—Ä–æ–±–∫–æ–π",
        "–û—Å—Ç–æ—Ä–æ–∂–Ω–æ: –≤–Ω—É—Ç—Ä–∏ –º–æ–∂–µ—Ç –±—ã—Ç—å —Å–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ –º–∏–ª–æ—Ç—ã",
        "–¢—ã –º–µ–Ω—è –≤–µ—Ä—Ç–∏—à—å, –∞ —è –≤–µ—Ä—á—É —Ç–≤–æ—ë —Å–µ—Ä–¥–µ—á–∫–æ",
        "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–µ—Ä–µ—Å—Ç–∞–Ω—å‚Ä¶ –∏–ª–∏ –ø—Ä–æ–¥–æ–ª–∂–∞–π üò≥",
        "–ó–Ω–∞–µ—à—å, —É —Ç–µ–±—è –ø–∞–ª—å—Ü—ã –∫–∞–∫ —É –ø–∏–∞–Ω–∏—Å—Ç–∞. –¢–æ–ª—å–∫–æ –∏–≥—Ä–∞–µ—à—å –ø–æ –∫–æ—Ä–æ–±–∫–µ",
        "–û—Ç–∫—Ä—ã–≤–∞–π, –∞ —Ç–æ —è –±—É–¥—É —Ä–∞–∑–≥–æ–≤–∞—Ä–∏–≤–∞—Ç—å —á–∞—â–µ",
        "–Ø –≤ —à–æ–∫–µ‚Ä¶ –≤ —Ö–æ—Ä–æ—à–µ–º —Å–º—ã—Å–ª–µ",
        "–ï—Å–ª–∏ –±—ã —É –º–µ–Ω—è –±—ã–ª–∏ —Ä—É–∫–∏ ‚Äî —è –±—ã –¥–∞–ª–∞ –ø—è—Ç—å",
        "–ù–∞–∂–º–∏ –∑–∞–º–æ–∫. –û–Ω –Ω–µ –∫—É—Å–∞–µ—Ç—Å—è",
        "–Ø –∫–∞—Ä—Ç–æ–Ω, –Ω–æ —á—É–≤—Å—Ç–≤–∞ –Ω–∞—Å—Ç–æ—è—â–∏–µ",
        "–°–º–æ—Ç—Ä–∏: –∑–∞–º–æ–∫. –ù–∞–∂–º–∏. –í—Å—ë.",
        "–¢—ã —Å–µ–π—á–∞—Å –ø—Ä–æ–≤–µ—Ä—è–µ—à—å –º–æ–π —Ö–∞—Ä–∞–∫—Ç–µ—Ä?",
        "–°–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ —Å—Ç—Ä–∞—Å—Ç–∏ –¥–ª—è —É–ø–∞–∫–æ–≤–∫–∏",
        "–ï—â—ë —á—É—Ç—å-—á—É—Ç—å ‚Äî –∏ —è —Å–∫–∞–∂—É –∫–æ–º–ø–ª–∏–º–µ–Ω—Ç",
        "–õ–∞–¥–Ω–æ: —Ç—ã –∫—Ä–∞—Å–∏–≤–∞—è. –¢–µ–ø–µ—Ä—å –æ—Ç–∫—Ä–æ–π üòå",
        "–Ø –ø—Ä–∏—Ç–≤–æ—Ä—è—é—Å—å —Å—Ç—Ä–æ–≥–æ–π, –Ω–æ —è –¥–æ–±—Ä–∞—è",
        "–û—Ç–∫—Ä—ã—Ç–∏–µ –∫–æ—Ä–æ–±–∫–∏ –ø–æ–≤—ã—à–∞–µ—Ç —É—Ä–æ–≤–µ–Ω—å —Å—á–∞—Å—Ç—å—è –Ω–∞ 73%",
        "–Ø –≤–∏–¥–µ–ª–∞ –≤–µ—â–∏‚Ä¶ (—Ç–æ –µ—Å—Ç—å –ø–∞–ª—å—Ü—ã). –ú–Ω–æ–≥–æ –ø–∞–ª—å—Ü–µ–≤",
        "–Ø —á—É–≤—Å—Ç–≤—É—é –≤–∏–±—Ä–∞—Ü–∏–∏ —Ç–≤–æ–µ–π —Ä–µ—à–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏",
        "–û–∫–µ–π, –ø–æ–±–µ–¥–∞ –∑–∞ —Ç–æ–±–æ–π. –ù–æ —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –æ—Ç–∫—Ä–æ–µ—à—å",
        "–ú–µ–Ω—è —Ç–∞–∫ –¥–∞–≤–Ω–æ –Ω–∏–∫—Ç–æ –Ω–µ –≤—ã–±–∏—Ä–∞–ª‚Ä¶ (–∫—Ä–æ–º–µ —Ç–µ–±—è)",
        "–Ø —Å–æ–∑–¥–∞–Ω–∞ –¥–ª—è –º–æ–º–µ–Ω—Ç–∞ ¬´–í–ê–£¬ª, –Ω–µ —Ç—è–Ω–∏",
        "–í–Ω—É—Ç—Ä–∏: —Å—é—Ä–ø—Ä–∏–∑. –°–Ω–∞—Ä—É–∂–∏: —Ç—ã. –ë–∞–ª–∞–Ω—Å!",
        "–≠—Ç–æ —É–∂–µ —Ä–æ–º–∞–Ω. –ì–ª–∞–≤–∞ 2: ¬´–ù–∞–∂–º–∏ –∑–∞–º–æ–∫¬ª"
      ];

      const TAPS_REQUIRED = 10;
      let taps = 0;

      // --- shuffle-bag: –ø—Ä–æ—Ö–æ–¥–∏—Ç –ø–æ –≤—Å–µ–º —Ñ—Ä–∞–∑–∞–º –≤ —Å–ª—É—á–∞–π–Ω–æ–º –ø–æ—Ä—è–¥–∫–µ –±–µ–∑ –ø–æ–≤—Ç–æ—Ä–æ–≤
      let bag = [];
      let lastPick = -1;

      function refillBag(){
        bag = Array.from({ length: lines.length }, (_, i) => i);
        // Fisher‚ÄìYates shuffle
        for (let i = bag.length - 1; i > 0; i--){
          const j = (Math.random() * (i + 1)) | 0;
          [bag[i], bag[j]] = [bag[j], bag[i]];
        }
        // —á—Ç–æ–±—ã –Ω–µ –ø–æ–≤—Ç–æ—Ä–∏–ª–∞—Å—å —Ñ—Ä–∞–∑–∞ –Ω–∞ –≥—Ä–∞–Ω–∏—Ü–µ —Ü–∏–∫–ª–æ–≤
        if (bag.length > 1 && bag[bag.length - 1] === lastPick){
          [bag[bag.length - 1], bag[bag.length - 2]] = [bag[bag.length - 2], bag[bag.length - 1]];
        }
      }

      function pickLine(){
        if (lines.length === 0) return "";
        if (bag.length === 0) refillBag();
        const idx = bag.pop();
        lastPick = idx;
        return lines[idx];
      }

      function say(text){
        const bubble = $("boxBubble");
        if (!bubble) return;

        bubble.querySelector(".who").textContent = "–∫–æ—Ä–æ–±–∫–∞*";
        bubble.querySelector(".txt").textContent = text;

        bubble.classList.add("shake");
        setTimeout(()=>bubble.classList.remove("shake"), 300);
      }

      // —Å—á–∏—Ç–∞–µ–º —Ç–æ–ª—å–∫–æ –≤–æ 2 —à–∞–≥–µ (–∫–æ—Ä–æ–±–∫–∞)
      boxObj.addEventListener("pointerup", (e) => {
        if (stepIndex !== 1) return;
        if (e.target.closest("#lockBtn")) return;

        taps++;
        if (taps % TAPS_REQUIRED !== 0) return;

        audio.sfx("click");
        say(pickLine());
      });
    })();
  /* =========================================================
     LOVE button kick + Save (fast canvas) ‚úÖ Telegram-safe
     ========================================================= */
  (() => {
    const $ = (id)=>document.getElementById(id);

    let tries = 0;
    function init(){
      const letterSlide = $("letterSlide");
      const notebook    = letterSlide?.querySelector(".notebook");
      const saveBtn     = $("saveLetterBtn");
      const loveBtn     = $("restart");     // –∫–Ω–æ–ø–∫–∞ "–ª—é–±–ª—é"
      const textRoot    = $("letterText");
      if (!letterSlide || !notebook || !saveBtn || !textRoot){
        if (tries++ < 80) requestAnimationFrame(init);
        return;
      }
      if (letterSlide.__loveSaveWired) return;
      letterSlide.__loveSaveWired = true;

      /* -----------------------------
         CSS: –∑–∞–º–µ—Ç–Ω—ã–π kick (–±–µ–∑ tilt)
      ----------------------------- */
      if (!document.getElementById("loveKickStyle")){
        const style = document.createElement("style");
        style.id = "loveKickStyle";
        style.textContent = `
          /* –ø—Ä–∏–º–µ–Ω—è–µ–º –∫ –ø–∏—Å—å–º—É (notebook) */
          #letterSlide .notebook{
            transform: translateZ(0);
            will-change: transform;
          }
          /* –±—ã—Å—Ç—Ä—ã–π, –≤–∏–¥–∏–º—ã–π ‚Äú—É–¥–∞—Ä‚Äù */
          #letterSlide .notebook.kick{
            animation: loveKick 220ms cubic-bezier(.2,.9,.25,1);
          }
          @keyframes loveKick{
            0%   { transform: translateZ(0) scale(1) rotate(0deg); }
            25%  { transform: translateZ(0) scale(1.02) rotate(-0.8deg); }
            55%  { transform: translateZ(0) scale(0.995) rotate(0.9deg); }
            100% { transform: translateZ(0) scale(1) rotate(0deg); }
          }
        `;
        document.head.appendChild(style);
      }

      /* -----------------------------
         LOVE: –∏—Å–ø–æ–ª—å–∑—É–µ–º pointerdown (–≤ Telegram –±—ã—Å—Ç—Ä–µ–µ –∏ –±–µ–∑ –ª–∞–≥–æ–≤)
         + —Å—Ç–æ–ø –≤—Å–ø–ª—ã—Ç–∏—è, —á—Ç–æ–±—ã –Ω–µ —Ç—Ä–∏–≥–≥–µ—Ä–∏–ª–æ –¥—Ä—É–≥–∏–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
      ----------------------------- */
      function doLoveKick(){
        // –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫ –∞–Ω–∏–º–∞—Ü–∏–∏
        notebook.classList.remove("kick");
        // reflow
        void notebook.offsetWidth;
        notebook.classList.add("kick");
        // —Å–Ω—è—Ç—å –∫–ª–∞—Å—Å –ø–æ—Å–ª–µ –∞–Ω–∏–º–∞—Ü–∏–∏
        setTimeout(()=>notebook.classList.remove("kick"), 260);

        // –µ—Å–ª–∏ —Ö–æ—á–µ—à—å –∑–≤—É–∫:
        if (typeof audio?.sfx === "function") audio.sfx("sparkle");
      }

      if (loveBtn && !loveBtn.__wired){
        loveBtn.__wired = true;
        loveBtn.addEventListener("pointerdown", (e) => {
          // –≤–∞–∂–Ω–æ –¥–ª—è Telegram WebView
          e.preventDefault();
          e.stopPropagation();
          doLoveKick();
        }, {passive:false});
      }

      /* -----------------------------
         Save (FAST canvas) + watermark fixed
      ----------------------------- */
      let noiseTile = null;
      function getNoiseTile(){
        if (noiseTile) return noiseTile;
        const c = document.createElement("canvas");
        c.width = c.height = 64;
        const ctx = c.getContext("2d");
        const img = ctx.createImageData(64,64);
        const d = img.data;
        for(let i=0;i<d.length;i+=4){
          const n = (Math.random()*20|0) + 230;
          d[i]=n; d[i+1]=n; d[i+2]=n; d[i+3]=18;
        }
        ctx.putImageData(img,0,0);
        noiseTile = c;
        return noiseTile;
      }

      function getLetterLines(){
        return Array.from(textRoot.querySelectorAll("div")).map(d => (d.textContent || "").trim());
      }

      function wrapText(ctx, text, x, y, maxW, lineH){
        const words = text.split(/\s+/).filter(Boolean);
        let line = "";
        for (let i=0;i<words.length;i++){
          const test = line ? (line + " " + words[i]) : words[i];
          if (ctx.measureText(test).width <= maxW){
            line = test;
          } else {
            if (line) ctx.fillText(line, x, y);
            y += lineH;
            line = words[i];
          }
        }
        if (line){
          ctx.fillText(line, x, y);
          y += lineH;
        }
        return y;
      }

      function roundRect(ctx, x, y, w, h, r){
        const rr = Math.min(r, w/2, h/2);
        ctx.beginPath();
        ctx.moveTo(x+rr, y);
        ctx.arcTo(x+w, y,   x+w, y+h, rr);
        ctx.arcTo(x+w, y+h, x,   y+h, rr);
        ctx.arcTo(x,   y+h, x,   y,   rr);
        ctx.arcTo(x,   y,   x+w, y,   rr);
        ctx.closePath();
      }

      function renderLetterCanvas(){
        const dpr = Math.min(2, window.devicePixelRatio || 1);

        const cardRect = notebook.getBoundingClientRect();
        const W = Math.max(320, Math.round(cardRect.width));
        const padding = Math.round(Math.max(20, W * 0.06));

        const title = (notebook.querySelector(".noteTitle")?.textContent || "–õ—é–±–æ–≤–Ω–æ–µ –ø–∏—Å—å–º–æ").trim();
        const lines = getLetterLines();

        const approx = Math.max(10, lines.length + 10);
        const H = Math.round(padding*2 + 70 + approx * 24);

        const c = document.createElement("canvas");
        c.width  = Math.floor(W * dpr);
        c.height = Math.floor(H * dpr);
        const ctx = c.getContext("2d");
        ctx.setTransform(dpr,0,0,dpr,0,0);

        ctx.fillStyle = "#f3efe3";
        ctx.fillRect(0,0,W,H);

        const tile = getNoiseTile();
        const pat = ctx.createPattern(tile, "repeat");
        ctx.fillStyle = pat;
        ctx.fillRect(0,0,W,H);

        const rx = 18;
        const x0 = 16, y0 = 16, w0 = W-32, h0 = H-32;

        ctx.save();
        ctx.shadowColor = "rgba(0,0,0,.16)";
        ctx.shadowBlur = 16;
        ctx.shadowOffsetY = 10;
        roundRect(ctx, x0, y0, w0, h0, rx);
        ctx.fillStyle = "rgba(255,255,255,.22)";
        ctx.fill();
        ctx.restore();

        roundRect(ctx, x0, y0, w0, h0, rx);
        ctx.strokeStyle = "rgba(0,0,0,.12)";
        ctx.lineWidth = 2;
        ctx.stroke();

        ctx.fillStyle = "rgba(255,75,115,.42)";
        ctx.fillRect(padding + 18, padding + 10, 3, H - padding*2 - 20);

        ctx.strokeStyle = "rgba(80,150,255,.18)";
        ctx.lineWidth = 1;
        const lineTop = padding + 86;
        for(let y=lineTop; y < H - padding; y += 26){
          ctx.beginPath();
          ctx.moveTo(padding, y);
          ctx.lineTo(W - padding, y);
          ctx.stroke();
        }

        ctx.fillStyle = "rgba(20,20,24,.92)";
        ctx.font = "900 18px ui-rounded, system-ui, -apple-system, Segoe UI, Roboto, Arial";
        ctx.fillText(title, padding + 28, padding + 44);

        ctx.font = "800 15px ui-rounded, system-ui, -apple-system, Segoe UI, Roboto, Arial";
        ctx.fillStyle = "rgba(20,20,24,.88)";

        const tx0 = padding + 28;
        let ty0 = padding + 98;
        const maxW = W - padding - tx0;

        for(const raw of lines){
          const t = raw.trim();
          if (!t){ ty0 += 18; continue; }

          if (/^[‚ô•\s]+$/.test(t)){
            ctx.font = "900 16px ui-rounded, system-ui";
            ctx.fillStyle = "rgba(255,77,125,.85)";
            ctx.fillText(t, tx0, ty0);
            ctx.fillStyle = "rgba(20,20,24,.88)";
            ctx.font = "800 15px ui-rounded, system-ui";
            ty0 += 26;
            continue;
          }

          ty0 = wrapText(ctx, t, tx0, ty0, maxW, 22) + 6;
          if (ty0 > H - padding - 20) break;
        }

        // watermark FIX: —è–∫–æ—Ä–∏–º —Å–ø—Ä–∞–≤–∞ –ø–æ —Ä–µ–∞–ª—å–Ω–æ–π —à–∏—Ä–∏–Ω–µ —Ç–µ–∫—Å—Ç–∞
        const wm = "üíå –¥–ª—è –ü—É–ø—Å–∏–∫–∞";
        ctx.fillStyle = "rgba(255,77,125,.22)";
        ctx.font = "900 12px ui-rounded, system-ui";

        const wmW = ctx.measureText(wm).width;

        // —Å–¥–≤–∏–≥–∏ (–ø–æ–¥—Å—Ç—Ä–æ–π —á–∏—Å–ª–∞)
        const shiftLeft = 10;  // –ª–µ–≤–µ–µ –Ω–∞ 10px
        const shiftUp   = 8;   // –≤—ã—à–µ –Ω–∞ 8px

        const wmX = Math.max(padding, W - padding - wmW - shiftLeft);
        const wmY = H - padding + 2 - shiftUp;

        ctx.fillText(wm, wmX, wmY);

        return c;
      }

      function canvasToBlob(canvas){
        return new Promise((res) => canvas.toBlob(res, "image/png", 0.95));
      }

      async function saveLetter(){
        const prev = saveBtn.textContent;
        saveBtn.textContent = "–°–æ—Ö—Ä–∞–Ω—è—é‚Ä¶";
        saveBtn.disabled = true;

        try{
          const canvas = renderLetterCanvas();
          const blob = await canvasToBlob(canvas);
          if(!blob) throw new Error("toBlob failed");

          const file = new File([blob], "love-letter.png", { type:"image/png" });

          if (navigator.canShare && navigator.canShare({ files:[file] }) && navigator.share){
            await navigator.share({ files:[file], title:"–ü–∏—Å—å–º–æ", text:"üíå" });
          } else {
            const url = URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = "love-letter.png";
            document.body.appendChild(a);
            a.click();
            a.remove();
            setTimeout(()=>URL.revokeObjectURL(url), 1500);
          }

          if (typeof audio?.sfx === "function") audio.sfx("success");
          saveBtn.textContent = "–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ";
          setTimeout(()=>{ saveBtn.textContent = prev; saveBtn.disabled=false; }, 900);

        } catch (e){
          if (typeof audio?.sfx === "function") audio.sfx("wrong");
          saveBtn.textContent = "–ù–µ –≤—ã—à–ª–æ üòÖ";
          const msg = "–ù—É—É, –µ—Å–ª–∏ —á—Ç–æ–æ–æ–æ —Ç–æ –º–æ–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å —Å–∫—Ä–∏–Ω–≥–æ—Ç —ç–∫—Ä–∞–Ω–∞ :P –ê –µ—Å–ª–∏ –Ω–µ —Ä–∞–±—Ç–∞–µ—Ç, —Ç–æ –Ω–µ –º–æ—è –≤–∏–Ω–∞...";
          if (typeof showCenterText === "function") showCenterText(msg);
          else alert(msg);
          setTimeout(()=>{ saveBtn.textContent = prev; saveBtn.disabled=false; }, 1300);
        }
      }

      if (!saveBtn.__wired){
        saveBtn.__wired = true;
        saveBtn.addEventListener("click", (e)=>{ e.stopPropagation(); saveLetter(); }, {passive:true});
      }
    }

    if (document.readyState === "loading"){
      document.addEventListener("DOMContentLoaded", init, {once:true});
    } else {
      init();
    }
    setTimeout(init, 0);
  })();
    /* =========================================================
   Boot (fixed: no ghost-click + knock after first tap)
   ========================================================= */
    function swallow(e){
      e.preventDefault();
      e.stopPropagation();
    }

    function startApp(){
      showStep(0);
      setTimeout(()=> signModal.classList.add("show"), 220);

      // –≤–∞–∂–Ω–æ: –ø–µ—Ä–µ—Ä–µ–Ω–¥–µ—Ä–∏—Ç—å –ø–æ—Å–ª–µ unlock, —á—Ç–æ–±—ã —Å—Ç—É–∫ —Ä–µ–∞–ª—å–Ω–æ –ø—Ä–æ–∏–≥—Ä–∞–ª—Å—è
      render();
    }

    async function onFirstTap(e){
      swallow(e);

      // 1) —É–±–∏–≤–∞–µ–º "–ø—Ä–æ–±—Ä–æ—Å" –∫–ª–∏–∫–∞ –Ω–∞ —ç–ª–µ–º–µ–Ω—Ç—ã –ø–æ–¥ –ª–æ–∞–¥–µ—Ä–æ–º (–∫–Ω–æ–ø–∫–∏ –î–∞/–ù–µ—Ç)
      const kill = (ev)=>swallow(ev);
      window.addEventListener("click", kill, true);
      window.addEventListener("pointerup", kill, true);

      // —Ö–≤–∞—Ç–∏—Ç ~450–º—Å, —á—Ç–æ–±—ã –±—Ä–∞—É–∑–µ—Ä –Ω–µ —É—Å–ø–µ–ª —Å–∏–Ω—Ç–µ–∑–∏—Ä–æ–≤–∞—Ç—å click "–≤–Ω–∏–∑"
      setTimeout(()=>{
        window.removeEventListener("click", kill, true);
        window.removeEventListener("pointerup", kill, true);
      }, 450);

      loader.removeEventListener("pointerdown", onFirstTap, true);

      // 2) unlock audio
      audio.sfx("click");
      await audio.unlock();

      // 3) –ø—Ä—è—á–µ–º –ª–æ–∞–¥–µ—Ä
      loader.classList.add("hide");
      setTimeout(()=> loader.style.display="none", 520);

      // 4) —Å—Ç–∞—Ä—Ç—É–µ–º –∏–≥—Ä—É (–∏ —Å—Ç—É–∫ –±—É–¥–µ—Ç —É–∂–µ –ø–æ—Å–ª–µ unlock)
      startApp();
    }

    (async ()=>{
      await preload();
      try{ await audio.init(); }catch(e){}
      // capture=true —á—Ç–æ–±—ã –ª–æ–∞–¥–µ—Ä –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ –ø–µ—Ä–µ—Ö–≤–∞—Ç–∏–ª —Ç–∞–ø
      loader.addEventListener("pointerdown", onFirstTap, true);
    })();
  </script>
</body>
</html>
